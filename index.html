<!DOCTYPE html>
<html lang="de">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(reg => console.log('‚úì Service Worker registered'))
                    .catch(err => console.log('‚úó Service Worker failed:', err));
            });
        }
    </script>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0a0a0a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Terminal Farm">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%230a0a0a'/><rect x='10' y='10' width='80' height='80' fill='%2300ff00'/><rect x='15' y='15' width='70' height='70' fill='%230a0a0a'/><text x='50' y='65' font-size='48' text-anchor='middle' fill='%2300ff00'>üåæ</text></svg>">
    <title>Terminal Farm</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        html {
            height: 100%;
            width: 100%;
            position: fixed;
            overflow: hidden;
            overscroll-behavior: none;
        }

        body {
            height: 100%;
            width: 100%;
            position: fixed;
            overflow: hidden;
            overscroll-behavior: none;
            touch-action: none;
            background: #0a0a0a;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            display: flex;
            flex-direction: column;
        }

        /* Blocking Screens */
        .blocking-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0a0a0a;
            z-index: 10000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .blocking-screen.active {
            display: flex;
        }

        .blocking-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .blocking-title {
            font-size: 24px;
            color: #ffaa00;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .blocking-text {
            font-size: 16px;
            color: #00aaff;
            max-width: 500px;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .blocking-steps {
            text-align: left;
            margin: 20px 0;
            max-width: 500px;
        }

        .blocking-steps div {
            color: #00ff00;
            margin: 10px 0;
            padding: 10px;
            background: #001100;
            border: 1px solid #00ff00;
            border-radius: 5px;
        }

        .btn {
            background: #001100;
            border: 2px solid #00ff00;
            color: #00ff00;
            padding: 12px 30px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            transition: all 0.3s;
            white-space: nowrap;
            margin: 10px;
        }

        .btn:hover {
            background: #00ff00;
            color: #000;
            transform: scale(1.05);
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn.large {
            padding: 20px 40px;
            font-size: 20px;
            font-weight: bold;
        }

        #header {
            padding: 15px 20px;
            border-bottom: 2px solid #00ff00;
            background: #000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            flex-shrink: 0;
            overflow: hidden;
        }

        .title {
            font-size: 18px;
            font-weight: bold;
            color: #00ff00;
        }

        #money-display {
            font-size: 20px;
            font-weight: bold;
            color: #ffaa00;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn.header-btn {
            padding: 8px 15px;
            font-size: 14px;
            margin: 0;
        }

        .sync-badge {
            font-size: 14px;
            padding: 8px 15px;
            border: 2px solid;
            border-radius: 5px;
            font-weight: bold;
        }

        .sync-badge.offline {
            color: #ff0000;
            border-color: #ff0000;
            background: #220000;
        }

        .sync-badge.online {
            color: #00ff00;
            border-color: #00ff00;
            background: #002200;
        }

        .sync-badge.syncing {
            color: #ffaa00;
            border-color: #ffaa00;
            background: #221100;
            animation: blink 1s infinite;
        }

        /* TERMINAL - ONLY SCROLLABLE ELEMENT */
        #terminal {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
            font-size: 14px;
            line-height: 1.6;
            min-height: 0;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            touch-action: pan-y;
            isolation: isolate;
        }

        #terminal::-webkit-scrollbar {
            width: 10px;
        }

        #terminal::-webkit-scrollbar-track {
            background: #0a0a0a;
        }

        #terminal::-webkit-scrollbar-thumb {
            background: #00ff00;
        }

        .output-line {
            margin: 5px 0;
            word-wrap: break-word;
            -webkit-user-select: text;
            user-select: text;
        }

        .success {
            color: #00ff00;
        }

        .error {
            color: #ff0000;
        }

        .warning {
            color: #ffaa00;
        }

        .info {
            color: #00aaff;
        }

        #input-line {
            display: flex;
            padding: 15px 20px;
            border-top: 2px solid #00ff00;
            background: #000;
            flex-shrink: 0;
            overflow: hidden;
            position: relative;
        }

        #prompt {
            color: #00ff00;
            margin-right: 10px;
            flex-shrink: 0;
        }

        #input {
            flex: 1;
            background: transparent;
            border: none;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            outline: none;
            min-width: 0;
            -webkit-user-select: text;
            user-select: text;
        }

        .growing {
            color: #ffaa00;
        }

        .ready {
            color: #00ff00;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        /* Modal Styles - Modal fest, Inhalt komplett scrollbar */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9000;
            overflow: hidden;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #0a0a0a;
            border: 2px solid #00ff00;
            padding: 30px;
            max-width: 700px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }

        .modal-content::-webkit-scrollbar {
            width: 10px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: #0a0a0a;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: #00ff00;
        }

        .modal-title {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #ffaa00;
            text-align: center;
        }

        .modal-item {
            padding: 12px;
            border: 1px solid #00ff00;
            margin-bottom: 10px;
            background: #001100;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-buttons .btn {
            margin: 0;
        }

        .save-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 25px 0;
        }

        .save-card {
            border: 3px solid #00ff00;
            padding: 20px;
            background: #001100;
            position: relative;
        }

        .save-card.recommended {
            border-color: #ffaa00;
            box-shadow: 0 0 20px rgba(255, 170, 0, 0.5);
        }

        .save-card-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ffaa00;
            color: #000;
            padding: 5px 10px;
            font-size: 12px;
            font-weight: bold;
            border-radius: 3px;
        }

        .save-card-title {
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 18px;
            color: #00ff00;
        }

        .save-stat {
            margin: 8px 0;
            font-size: 14px;
            padding: 5px;
            background: #000a00;
        }

        .choice-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .choice-buttons .btn {
            flex: 1;
            margin: 0;
        }

        .tutorial-step {
            background: #001100;
            border: 2px solid #ffaa00;
            padding: 20px;
            margin: 15px 0;
            border-radius: 5px;
        }

        .tutorial-step h3 {
            color: #ffaa00;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .status-item {
            margin-bottom: 15px;
            padding: 12px;
            border: 1px solid #00ff00;
            background: #001100;
        }

        .status-item-title {
            color: #ffaa00;
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .status-item-content {
            color: #00ff00;
            margin-left: 10px;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .save-comparison {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Screen Size Warning -->
    <div id="screenWarning" class="blocking-screen">
        <div class="blocking-icon">üì±‚ùå</div>
        <div class="blocking-title">Bildschirm zu klein</div>
        <div class="blocking-text">
            Terminal Farm ben√∂tigt einen gr√∂√üeren Bildschirm.<br><br>
            <strong>Mindestanforderungen:</strong><br>
            ‚Ä¢ Breite: 768px<br>
            ‚Ä¢ H√∂he: 600px<br><br>
            Bitte verwende ein Tablet, iPad oder Computer.
        </div>
    </div>

    <!-- PWA Required Screen -->
    <div id="pwaRequired" class="blocking-screen">
        <div class="blocking-icon">üì±</div>
        <div class="blocking-title">App-Installation erforderlich</div>
        <div class="blocking-text">
            Terminal Farm muss als App installiert werden.
        </div>
        <div class="blocking-steps">
            <div><strong>üì± iOS (Safari):</strong><br>Teilen ‚Üí Zum Home-Bildschirm</div>
            <div><strong>ü§ñ Android (Chrome):</strong><br>Men√º (‚ãÆ) ‚Üí App installieren</div>
            <div><strong>üíª Desktop (Chrome/Edge):</strong><br>Adressleiste ‚Üí App installieren (‚äï)</div>
        </div>
        <div class="blocking-text" style="color: #ffaa00; margin-top: 20px;">
            Nach der Installation √∂ffne die App vom Home-Bildschirm!
        </div>
    </div>

    <!-- Cloud Restore Modal -->
    <div id="cloudRestoreModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">‚òÅÔ∏è CLOUD-SICHERUNG WIEDERHERSTELLEN</div>
            <div id="cloudRestoreContent"></div>
        </div>
    </div>

    <!-- Main Game UI -->
    <div id="gameContainer" style="display: none; flex: 1; display: flex; flex-direction: column;">
        <div id="header">
            <div class="title">üåæ TERMINAL FARM üåæ</div>
            <div id="money-display">üí∞ 0 ‚Ç¨</div>
            <div class="header-buttons">
                <span class="sync-badge online" id="syncBadge">‚óè Online</span>
                <button class="btn header-btn" id="statusBtn">üìä Status</button>
                <button class="btn header-btn" id="inventoryBtn">üì¶ Inventar</button>
                <button class="btn header-btn" id="settingsBtn">‚öôÔ∏è</button>
            </div>
        </div>

        <div id="terminal"></div>

        <div id="input-line">
            <span id="prompt">farm@terminal:~$</span>
            <input type="text" id="input" autocomplete="off" autofocus>
        </div>
    </div>

    <!-- Status Modal -->
    <div id="statusModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">üìä FARM STATUS</div>
            <div id="statusContent"></div>
            <div class="modal-buttons">
                <button class="btn" id="closeStatusBtn">Schlie√üen</button>
            </div>
        </div>
    </div>

    <!-- Inventory Modal -->
    <div id="inventoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">üì¶ INVENTAR</div>
            <div id="inventoryContent"></div>
            <div class="modal-buttons">
                <button class="btn" id="closeInventoryBtn">Schlie√üen</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">‚öôÔ∏è EINSTELLUNGEN</div>
            <div id="settingsContent"></div>
        </div>
    </div>

    <!-- Tutorial Modal -->
    <div id="tutorialModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">üéì WILLKOMMEN BEI TERMINAL FARM!</div>
            <div id="tutorialContent"></div>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GithubAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDPiVhUPuJXhRRjbrftX67IBi2S7B_E3ps",
            authDomain: "term-farm.firebaseapp.com",
            projectId: "term-farm",
            storageBucket: "term-farm.firebasestorage.app",
            messagingSenderId: "319818614073",
            appId: "1:319818614073:web:5f348158b015c3378054e8",
            measurementId: "G-19VJCT6SPG"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GithubAuthProvider();

        // ============================================
        // ACCESS CONTROL - PWA & SCREEN SIZE REQUIRED
        // ============================================

        function isPWA() {
            return window.matchMedia('(display-mode: standalone)').matches || 
                   window.navigator.standalone === true ||
                   document.referrer.includes('android-app://');
        }

        function checkScreenSize() {
            return window.innerWidth >= 768 && window.innerHeight >= 600;
        }

        function updateAccessControl() {
            const screenOK = checkScreenSize();
            const pwaOK = isPWA();

            document.getElementById('screenWarning').classList.toggle('active', !screenOK);
            document.getElementById('pwaRequired').classList.toggle('active', screenOK && !pwaOK);
            document.getElementById('gameContainer').style.display = (screenOK && pwaOK) ? 'flex' : 'none';

            return screenOK && pwaOK;
        }

        // ============================================
        // GAME STATE
        // ============================================

        let game = {
            money: 50,
            wheat: 0,
            apples: 0,
            flour: 0,
            wheatFields: 3,
            appleTrees: 2,
            mills: 1,
            wheatGrowing: [],
            applesGrowing: [],
            flourProducing: [],
            tutorialCompleted: false,
            lastUpdate: Date.now(),
            prices: {
                wheat: 8,
                apple: 15,
                flour: 25,
                wheatField: 100,
                appleTree: 200,
                mill: 400
            },
            growthTimes: {
                wheat: 30000,
                apple: 60000,
                flour: 120000
            }
        };

        let currentUser = null;
        let isOnline = navigator.onLine;
        let lastCloudBackup = 0;

        // DOM Elements
        const terminal = document.getElementById('terminal');
        const input = document.getElementById('input');
        const moneyDisplay = document.getElementById('money-display');
        const syncBadge = document.getElementById('syncBadge');

        // ============================================
        // PRINT & DISPLAY
        // ============================================

        function print(text, className = '') {
            const line = document.createElement('div');
            line.className = 'output-line ' + className;
            line.textContent = text;
            terminal.appendChild(line);
            terminal.scrollTop = terminal.scrollHeight;
        }

        function updateDisplay() {
            moneyDisplay.textContent = `üí∞ ${game.money} ‚Ç¨`;
            updateSyncBadge();
        }

        function updateSyncBadge() {
            if (!isOnline) {
                syncBadge.className = 'sync-badge offline';
                syncBadge.textContent = '‚óè Offline';
            } else {
                syncBadge.className = 'sync-badge online';
                syncBadge.textContent = '‚óè Online';
            }
        }

        // ============================================
        // LOCAL STORAGE ONLY
        // ============================================

        function saveLocal() {
            try {
                game.lastUpdate = Date.now();
                const data = {
                    ...game,
                    wheatGrowing: game.wheatGrowing.map(item => ({
                        elapsed: Date.now() - item.startTime
                    })),
                    applesGrowing: game.applesGrowing.map(item => ({
                        elapsed: Date.now() - item.startTime
                    })),
                    flourProducing: game.flourProducing.map(item => ({
                        elapsed: Date.now() - item.startTime
                    })),
                    version: '3.0'
                };
                localStorage.setItem('terminalFarmSave', JSON.stringify(data));
            } catch (error) {
                console.error('Local save failed:', error);
            }
        }

        function loadLocal() {
            try {
                const saved = localStorage.getItem('terminalFarmSave');
                if (saved) {
                    const data = JSON.parse(saved);
                    Object.assign(game, data);
                    game.wheatGrowing = (game.wheatGrowing || []).map(item => ({
                        startTime: Date.now() - (item.elapsed || 0)
                    }));
                    game.applesGrowing = (game.applesGrowing || []).map(item => ({
                        startTime: Date.now() - (item.elapsed || 0)
                    }));
                    game.flourProducing = (game.flourProducing || []).map(item => ({
                        startTime: Date.now() - (item.elapsed || 0)
                    }));
                }
            } catch (error) {
                console.error('Local load failed:', error);
            }
        }

        // ============================================
        // MANUAL CLOUD BACKUP/RESTORE
        // ============================================

        async function backupToCloud() {
            if (!currentUser || !isOnline) {
                print('‚ùå Nicht eingeloggt oder offline!', 'error');
                return false;
            }
            
            try {
                print('‚òÅÔ∏è Sichere in Cloud...', 'info');
                
                game.lastUpdate = Date.now();
                const data = {
                    ...game,
                    wheatGrowing: game.wheatGrowing.map(item => ({
                        elapsed: Date.now() - item.startTime
                    })),
                    applesGrowing: game.applesGrowing.map(item => ({
                        elapsed: Date.now() - item.startTime
                    })),
                    flourProducing: game.flourProducing.map(item => ({
                        elapsed: Date.now() - item.startTime
                    })),
                    backedUpAt: Date.now(),
                    version: '3.0'
                };
                
                await setDoc(doc(db, "farms", currentUser.uid), data);
                lastCloudBackup = Date.now();
                print('‚úì Cloud-Sicherung erfolgreich!', 'success');
                return true;
            } catch (error) {
                console.error('Cloud backup failed:', error);
                print('‚ùå Cloud-Sicherung fehlgeschlagen!', 'error');
                return false;
            }
        }

        async function restoreFromCloud() {
            if (!currentUser || !isOnline) {
                print('‚ùå Nicht eingeloggt oder offline!', 'error');
                return;
            }
            
            try {
                print('‚òÅÔ∏è Lade Cloud-Sicherung...', 'info');
                
                const docRef = doc(db, "farms", currentUser.uid);
                const docSnap = await getDoc(docRef);
                
                if (!docSnap.exists()) {
                    print('‚ùå Keine Cloud-Sicherung gefunden!', 'error');
                    return;
                }
                
                const cloudData = docSnap.data();
                const localData = JSON.parse(localStorage.getItem('terminalFarmSave') || '{}');
                
                showRestoreComparison(localData, cloudData);
            } catch (error) {
                console.error('Cloud restore failed:', error);
                print('‚ùå Wiederherstellung fehlgeschlagen!', 'error');
            }
        }

        function calculateProgress(data) {
            return (data.money || 0) + 
                   (data.wheat || 0) * 8 + 
                   (data.apples || 0) * 15 + 
                   (data.flour || 0) * 25 +
                   (data.wheatFields || 0) * 100 +
                   (data.appleTrees || 0) * 200 +
                   (data.mills || 0) * 400;
        }

        function showRestoreComparison(localData, cloudData) {
            const modal = document.getElementById('cloudRestoreModal');
            const content = document.getElementById('cloudRestoreContent');
            
            const localDate = new Date(localData.lastUpdate || 0);
            const cloudDate = new Date(cloudData.lastUpdate || 0);
            
            const localScore = calculateProgress(localData);
            const cloudScore = calculateProgress(cloudData);
            const localRecommended = localScore >= cloudScore;
            
            content.innerHTML = `
                <div style="text-align: center; margin-bottom: 25px;">
                    <div style="color: #00aaff; font-size: 14px;">
                        M√∂chtest du die Cloud-Sicherung wiederherstellen?
                    </div>
                </div>
                
                <div class="save-comparison">
                    <div class="save-card ${localRecommended ? 'recommended' : ''}">
                        ${localRecommended ? '<div class="save-card-badge">‚≠ê AKTUELL</div>' : ''}
                        <div class="save-card-title">üíæ AKTUELLER STAND</div>
                        <div class="save-stat"><strong>üìÖ Datum:</strong> ${localDate.toLocaleString('de-DE')}</div>
                        <div class="save-stat"><strong>üí∞ Geld:</strong> ${localData.money} ‚Ç¨</div>
                        <div class="save-stat"><strong>üåæ Weizen:</strong> ${localData.wheat}</div>
                        <div class="save-stat"><strong>üçé √Ñpfel:</strong> ${localData.apples}</div>
                        <div class="save-stat"><strong>üè∫ Mehl:</strong> ${localData.flour}</div>
                        <div class="save-stat"><strong>üèóÔ∏è Felder:</strong> ${localData.wheatFields || 0}</div>
                        <div class="save-stat"><strong>üå≥ B√§ume:</strong> ${localData.appleTrees || 0}</div>
                        <div class="save-stat"><strong>‚öôÔ∏è M√ºhlen:</strong> ${localData.mills || 0}</div>
                        <div class="save-stat" style="background: #002200; color: #00ff00; margin-top: 10px;">
                            <strong>üìä Fortschritt:</strong> ${localScore} Punkte
                        </div>
                    </div>
                    
                    <div class="save-card ${!localRecommended ? 'recommended' : ''}">
                        ${!localRecommended ? '<div class="save-card-badge">‚≠ê EMPFOHLEN</div>' : ''}
                        <div class="save-card-title">‚òÅÔ∏è CLOUD-SICHERUNG</div>
                        <div class="save-stat"><strong>üìÖ Datum:</strong> ${cloudDate.toLocaleString('de-DE')}</div>
                        <div class="save-stat"><strong>üí∞ Geld:</strong> ${cloudData.money} ‚Ç¨</div>
                        <div class="save-stat"><strong>üåæ Weizen:</strong> ${cloudData.wheat}</div>
                        <div class="save-stat"><strong>üçé √Ñpfel:</strong> ${cloudData.apples}</div>
                        <div class="save-stat"><strong>üè∫ Mehl:</strong> ${cloudData.flour}</div>
                        <div class="save-stat"><strong>üèóÔ∏è Felder:</strong> ${cloudData.wheatFields || 0}</div>
                        <div class="save-stat"><strong>üå≥ B√§ume:</strong> ${cloudData.appleTrees || 0}</div>
                        <div class="save-stat"><strong>‚öôÔ∏è M√ºhlen:</strong> ${cloudData.mills || 0}</div>
                        <div class="save-stat" style="background: #002200; color: #00ff00; margin-top: 10px;">
                            <strong>üìä Fortschritt:</strong> ${cloudScore} Punkte
                        </div>
                    </div>
                </div>
                
                <div class="choice-buttons">
                    <button class="btn" id="keepCurrentBtn" style="font-size: 16px; padding: 15px;">
                        üíæ Aktuell behalten
                    </button>
                    <button class="btn" id="restoreCloudBtn" style="font-size: 16px; padding: 15px;">
                        ‚òÅÔ∏è Cloud wiederherstellen
                    </button>
                </div>
            `;
            
            document.getElementById('keepCurrentBtn').addEventListener('click', () => {
                modal.classList.remove('active');
                print('‚úì Aktueller Spielstand beibehalten', 'success');
                print('');
            });
            
            document.getElementById('restoreCloudBtn').addEventListener('click', () => {
                modal.classList.remove('active');
                Object.assign(game, cloudData);
                game.wheatGrowing = (game.wheatGrowing || []).map(item => ({
                    startTime: Date.now() - (item.elapsed || 0)
                }));
                game.applesGrowing = (game.applesGrowing || []).map(item => ({
                    startTime: Date.now() - (item.elapsed || 0)
                }));
                game.flourProducing = (game.flourProducing || []).map(item => ({
                    startTime: Date.now() - (item.elapsed || 0)
                }));
                saveLocal();
                updateDisplay();
                print('‚úì Cloud-Sicherung wiederhergestellt!', 'success');
                print('');
            });
            
            modal.classList.add('active');
        }

        // ============================================
        // AUTHENTICATION (OPTIONAL)
        // ============================================

        async function githubLogin() {
            try {
                const result = await signInWithPopup(auth, provider);
                currentUser = result.user;
                print(`‚úì Eingeloggt als: ${currentUser.displayName || 'GitHub User'}`, 'success');
                print('Du kannst jetzt Cloud-Sicherungen erstellen!', 'info');
                print('');
                
                // Lade Cloud-Status
                if (isOnline) {
                    try {
                        const docRef = doc(db, "farms", currentUser.uid);
                        const docSnap = await getDoc(docRef);
                        
                        if (docSnap.exists()) {
                            const cloudData = docSnap.data();
                            lastCloudBackup = cloudData.backedUpAt || cloudData.lastUpdate || 0;
                            print('‚òÅÔ∏è Cloud-Sicherung gefunden!', 'info');
                            print('Tippe "restore" um sie wiederherzustellen.', 'warning');
                            print('');
                        }
                    } catch (error) {
                        console.error('Could not load cloud status:', error);
                    }
                }
            } catch (error) {
                console.error('Login failed:', error);
                print('‚ùå Login fehlgeschlagen', 'error');
            }
        }

        async function logout() {
            try {
                await signOut(auth);
                currentUser = null;
                lastCloudBackup = 0;
                print('‚úì Ausgeloggt', 'success');
                print('');
            } catch (error) {
                console.error('Logout failed:', error);
            }
        }

        // ============================================
        // MODALS
        // ============================================

        function openStatus() {
            const modal = document.getElementById('statusModal');
            const content = document.getElementById('statusContent');
            
            let html = '';
            
            if (game.wheatGrowing.length > 0) {
                html += '<div class="status-item"><div class="status-item-title">üåæ WEIZEN W√ÑCHST:</div>';
                game.wheatGrowing.forEach((item, i) => {
                    const elapsed = Date.now() - item.startTime;
                    const remaining = Math.max(0, Math.ceil((game.growthTimes.wheat - elapsed) / 1000));
                    const status = remaining > 0 ? `noch ${remaining}s` : '‚úì FERTIG!';
                    const className = remaining > 0 ? 'growing' : 'ready';
                    html += `<div class="status-item-content ${className}">[${i+1}] ${status}</div>`;
                });
                html += '</div>';
            }
            
            if (game.applesGrowing.length > 0) {
                html += '<div class="status-item"><div class="status-item-title">üçé √ÑPFEL WACHSEN:</div>';
                game.applesGrowing.forEach((item, i) => {
                    const elapsed = Date.now() - item.startTime;
                    const remaining = Math.max(0, Math.ceil((game.growthTimes.apple - elapsed) / 1000));
                    const status = remaining > 0 ? `noch ${remaining}s` : '‚úì FERTIG!';
                    const className = remaining > 0 ? 'growing' : 'ready';
                    html += `<div class="status-item-content ${className}">[${i+1}] ${status}</div>`;
                });
                html += '</div>';
            }
            
            if (game.flourProducing.length > 0) {
                html += '<div class="status-item"><div class="status-item-title">üè∫ MEHL PRODUKTION:</div>';
                game.flourProducing.forEach((item, i) => {
                    const elapsed = Date.now() - item.startTime;
                    const remaining = Math.max(0, Math.ceil((game.growthTimes.flour - elapsed) / 1000));
                    const status = remaining > 0 ? `noch ${remaining}s` : '‚úì FERTIG!';
                    const className = remaining > 0 ? 'growing' : 'ready';
                    html += `<div class="status-item-content ${className}">[${i+1}] ${status}</div>`;
                });
                html += '</div>';
            }
            
            if (game.wheatGrowing.length === 0 && game.applesGrowing.length === 0 && game.flourProducing.length === 0) {
                html += '<div class="status-item"><div class="status-item-title">üå± PRODUKTION:</div>';
                html += '<div class="status-item-content" style="color: #ffaa00;">Nichts w√§chst gerade</div></div>';
            }
            
            html += '<div class="status-item"><div class="status-item-title">üèóÔ∏è GEB√ÑUDE:</div>';
            html += `<div class="status-item-content">üåæ Weizenfelder: ${game.wheatFields}</div>`;
            html += `<div class="status-item-content">üçé Apfelb√§ume: ${game.appleTrees}</div>`;
            html += `<div class="status-item-content">‚öôÔ∏è M√ºhlen: ${game.mills}</div>`;
            html += '</div>';
            
            content.innerHTML = html;
            modal.classList.add('active');
        }

        function closeStatus() {
            document.getElementById('statusModal').classList.remove('active');
        }

        function openInventory() {
            const modal = document.getElementById('inventoryModal');
            const content = document.getElementById('inventoryContent');
            
            content.innerHTML = `
                <div class="modal-item">
                    <strong>üåæ Weizen:</strong> ${game.wheat} Einheiten
                </div>
                <div class="modal-item">
                    <strong>üçé √Ñpfel:</strong> ${game.apples} Einheiten
                </div>
                <div class="modal-item">
                    <strong>üè∫ Mehl:</strong> ${game.flour} Einheiten
                </div>
                <div class="modal-item" style="border-color: #ffaa00; background: #221100;">
                    <strong>üí∞ Geld:</strong> ${game.money} ‚Ç¨
                </div>
            `;
            
            modal.classList.add('active');
        }

        function closeInventory() {
            document.getElementById('inventoryModal').classList.remove('active');
        }

        function openSettings() {
            const modal = document.getElementById('settingsModal');
            const content = document.getElementById('settingsContent');
            
            const loginStatus = currentUser 
                ? `‚úì Eingeloggt als ${currentUser.displayName || 'GitHub User'}`
                : '‚úó Nicht eingeloggt';
            
            const cloudBackupInfo = lastCloudBackup > 0
                ? `Letzte Cloud-Sicherung: ${new Date(lastCloudBackup).toLocaleString('de-DE')}`
                : 'Keine Cloud-Sicherung vorhanden';
            
            content.innerHTML = `
                <div class="status-item">
                    <div class="status-item-title">üë§ ACCOUNT STATUS</div>
                    <div class="status-item-content">${loginStatus}</div>
                    ${currentUser ? `<div class="status-item-content" style="color: #00aaff; margin-top: 10px;">${cloudBackupInfo}</div>` : ''}
                </div>
                
                <div class="status-item">
                    <div class="status-item-title">‚òÅÔ∏è CLOUD FUNKTIONEN</div>
                    <div class="status-item-content" style="color: #00aaff;">
                        Cloud-Sicherungen erm√∂glichen dir, deinen Spielstand auf mehreren Ger√§ten zu synchronisieren.
                    </div>
                </div>
                
                <div class="status-item">
                    <div class="status-item-title">üìñ VERF√úGBARE BEFEHLE</div>
                    <div class="status-item-content">login - Mit GitHub einloggen</div>
                    <div class="status-item-content">logout - Von GitHub ausloggen</div>
                    <div class="status-item-content">backup - Cloud-Sicherung erstellen</div>
                    <div class="status-item-content">restore - Cloud-Sicherung wiederherstellen</div>
                    <div class="status-item-content">help - Alle Befehle anzeigen</div>
                </div>
                
                <div class="modal-buttons">
                    ${currentUser 
                        ? '<button class="btn" id="logoutBtn">Ausloggen</button>' 
                        : '<button class="btn" id="loginBtn">Mit GitHub einloggen</button>'}
                    <button class="btn" id="closeSettingsBtn">Schlie√üen</button>
                </div>
            `;
            
            if (currentUser) {
                document.getElementById('logoutBtn').addEventListener('click', async () => {
                    await logout();
                    modal.classList.remove('active');
                });
            } else {
                document.getElementById('loginBtn').addEventListener('click', async () => {
                    modal.classList.remove('active');
                    await githubLogin();
                });
            }
            
            document.getElementById('closeSettingsBtn').addEventListener('click', () => {
                modal.classList.remove('active');
            });
            
            modal.classList.add('active');
        }

        function showTutorial() {
            const modal = document.getElementById('tutorialModal');
            const content = document.getElementById('tutorialContent');
            
            content.innerHTML = `
                <div class="tutorial-step">
                    <h3>üåæ 1. PFLANZEN & ERNTEN</h3>
                    <p>Tippe <strong>plant wheat</strong> um Weizen anzupflanzen (kostet 2‚Ç¨)</p>
                    <p>Nach 30 Sekunden kannst du mit <strong>harvest wheat</strong> ernten</p>
                    <p>Verkaufe deinen Weizen mit <strong>sell wheat</strong> f√ºr 8‚Ç¨!</p>
                </div>
                
                <div class="tutorial-step">
                    <h3>üçé 2. √ÑPFEL ANBAUEN</h3>
                    <p>Tippe <strong>plant apples</strong> um √Ñpfel anzubauen (kostet 5‚Ç¨)</p>
                    <p>Nach 60 Sekunden kannst du mit <strong>harvest apples</strong> ernten</p>
                    <p>Verkaufe deine √Ñpfel mit <strong>sell apples</strong> f√ºr 15‚Ç¨!</p>
                </div>
                
                <div class="tutorial-step">
                    <h3>üè∫ 3. MEHL PRODUZIEREN</h3>
                    <p>Tippe <strong>produce flour</strong> um Mehl herzustellen (kostet 3 Weizen)</p>
                    <p>Nach 120 Sekunden ist das Mehl fertig: <strong>collect flour</strong></p>
                    <p>Verkaufe dein Mehl mit <strong>sell flour</strong> f√ºr 25‚Ç¨!</p>
                </div>
                
                <div class="tutorial-step">
                    <h3>üèóÔ∏è 4. EXPANDIEREN</h3>
                    <p>Kaufe mehr Felder mit <strong>buy field</strong> (100‚Ç¨)</p>
                    <p>Kaufe mehr B√§ume mit <strong>buy tree</strong> (200‚Ç¨)</p>
                    <p>Kaufe mehr M√ºhlen mit <strong>buy mill</strong> (400‚Ç¨)</p>
                </div>
                
                <div class="tutorial-step">
                    <h3>üìä 5. √úBERSICHT</h3>
                    <p>Nutze die Buttons oben:</p>
                    <p><strong>üìä Status</strong> - Zeigt was gerade w√§chst</p>
                    <p><strong>üì¶ Inventar</strong> - Zeigt deine Ressourcen</p>
                    <p><strong>‚öôÔ∏è Einstellungen</strong> - Cloud-Sicherung & mehr</p>
                </div>
                
                <div class="modal-buttons">
                    <button class="btn large" id="closeTutorialBtn">Los geht's! üöÄ</button>
                </div>
            `;
            
            document.getElementById('closeTutorialBtn').addEventListener('click', () => {
                modal.classList.remove('active');
                game.tutorialCompleted = true;
                saveLocal();
                print('‚úì Tutorial abgeschlossen! Viel Erfolg! üåæ', 'success');
                print('');
            });
            
            modal.classList.add('active');
        }

        // ============================================
        // GAME COMMANDS
        // ============================================

        const commands = {
            help: () => {
                print('üìñ VERF√úGBARE BEFEHLE:', 'info');
                print('');
                print('üåæ WEIZEN:');
                print('  plant wheat    - Weizen pflanzen (2‚Ç¨, 30s)');
                print('  harvest wheat  - Weizen ernten');
                print('  sell wheat     - Weizen verkaufen (8‚Ç¨)');
                print('');
                print('üçé √ÑPFEL:');
                print('  plant apples   - √Ñpfel pflanzen (5‚Ç¨, 60s)');
                print('  harvest apples - √Ñpfel ernten');
                print('  sell apples    - √Ñpfel verkaufen (15‚Ç¨)');
                print('');
                print('üè∫ MEHL:');
                print('  produce flour  - Mehl herstellen (3 Weizen, 120s)');
                print('  collect flour  - Mehl einsammeln');
                print('  sell flour     - Mehl verkaufen (25‚Ç¨)');
                print('');
                print('üèóÔ∏è GEB√ÑUDE:');
                print('  buy field      - Weizenfeld kaufen (100‚Ç¨)');
                print('  buy tree       - Apfelbaum kaufen (200‚Ç¨)');
                print('  buy mill       - M√ºhle kaufen (400‚Ç¨)');
                print('');
                print('‚òÅÔ∏è CLOUD:');
                print('  login          - Mit GitHub einloggen');
                print('  logout         - Von GitHub ausloggen');
                print('  backup         - In Cloud sichern');
                print('  restore        - Von Cloud wiederherstellen');
                print('');
                print('üìä INFO:');
                print('  status         - Produktionsstatus');
                print('  inventory      - Inventar anzeigen');
                print('  prices         - Preis√ºbersicht');
                print('  tutorial       - Tutorial erneut anzeigen');
                print('  clear          - Terminal leeren');
                print('');
            },

            'plant wheat': () => {
                if (game.wheatGrowing.length >= game.wheatFields) {
                    print(`‚ùå Alle ${game.wheatFields} Felder belegt!`, 'error');
                    return;
                }
                if (game.money < 2) {
                    print('‚ùå Nicht genug Geld! (ben√∂tigt: 2‚Ç¨)', 'error');
                    return;
                }
                game.money -= 2;
                game.wheatGrowing.push({ startTime: Date.now() });
                print('üåæ Weizen gepflanzt! (W√§chst 30 Sekunden)', 'success');
                updateDisplay();
                saveLocal();
            },

            'harvest wheat': () => {
                const now = Date.now();
                let harvested = 0;
                game.wheatGrowing = game.wheatGrowing.filter(item => {
                    if (now - item.startTime >= game.growthTimes.wheat) {
                        harvested++;
                        return false;
                    }
                    return true;
                });
                
                if (harvested > 0) {
                    game.wheat += harvested;
                    print(`‚úì ${harvested} Weizen geerntet!`, 'success');
                    updateDisplay();
                    saveLocal();
                } else {
                    print('‚ùå Kein Weizen fertig!', 'error');
                }
            },

            'sell wheat': () => {
                if (game.wheat === 0) {
                    print('‚ùå Kein Weizen im Inventar!', 'error');
                    return;
                }
                const earned = game.wheat * game.prices.wheat;
                game.money += earned;
                print(`üí∞ ${game.wheat} Weizen f√ºr ${earned}‚Ç¨ verkauft!`, 'success');
                game.wheat = 0;
                updateDisplay();
                saveLocal();
            },

            'plant apples': () => {
                if (game.applesGrowing.length >= game.appleTrees) {
                    print(`‚ùå Alle ${game.appleTrees} B√§ume belegt!`, 'error');
                    return;
                }
                if (game.money < 5) {
                    print('‚ùå Nicht genug Geld! (ben√∂tigt: 5‚Ç¨)', 'error');
                    return;
                }
                game.money -= 5;
                game.applesGrowing.push({ startTime: Date.now() });
                print('üçé √Ñpfel gepflanzt! (W√§chst 60 Sekunden)', 'success');
                updateDisplay();
                saveLocal();
            },

            'harvest apples': () => {
                const now = Date.now();
                let harvested = 0;
                game.applesGrowing = game.applesGrowing.filter(item => {
                    if (now - item.startTime >= game.growthTimes.apple) {
                        harvested++;
                        return false;
                    }
                    return true;
                });
                
                if (harvested > 0) {
                    game.apples += harvested;
                    print(`‚úì ${harvested} √Ñpfel geerntet!`, 'success');
                    updateDisplay();
                    saveLocal();
                } else {
                    print('‚ùå Keine √Ñpfel fertig!', 'error');
                }
            },

            'sell apples': () => {
                if (game.apples === 0) {
                    print('‚ùå Keine √Ñpfel im Inventar!', 'error');
                    return;
                }
                const earned = game.apples * game.prices.apple;
                game.money += earned;
                print(`üí∞ ${game.apples} √Ñpfel f√ºr ${earned}‚Ç¨ verkauft!`, 'success');
                game.apples = 0;
                updateDisplay();
                saveLocal();
            },

            'produce flour': () => {
                if (game.flourProducing.length >= game.mills) {
                    print(`‚ùå Alle ${game.mills} M√ºhlen belegt!`, 'error');
                    return;
                }
                if (game.wheat < 3) {
                    print('‚ùå Nicht genug Weizen! (ben√∂tigt: 3)', 'error');
                    return;
                }
                game.wheat -= 3;
                game.flourProducing.push({ startTime: Date.now() });
                print('üè∫ Mehlproduktion gestartet! (Dauert 120 Sekunden)', 'success');
                updateDisplay();
                saveLocal();
            },

            'collect flour': () => {
                const now = Date.now();
                let collected = 0;
                game.flourProducing = game.flourProducing.filter(item => {
                    if (now - item.startTime >= game.growthTimes.flour) {
                        collected++;
                        return false;
                    }
                    return true;
                });
                
                if (collected > 0) {
                    game.flour += collected;
                    print(`‚úì ${collected} Mehl eingesammelt!`, 'success');
                    updateDisplay();
                    saveLocal();
                } else {
                    print('‚ùå Kein Mehl fertig!', 'error');
                }
            },

            'sell flour': () => {
                if (game.flour === 0) {
                    print('‚ùå Kein Mehl im Inventar!', 'error');
                    return;
                }
                const earned = game.flour * game.prices.flour;
                game.money += earned;
                print(`üí∞ ${game.flour} Mehl f√ºr ${earned}‚Ç¨ verkauft!`, 'success');
                game.flour = 0;
                updateDisplay();
                saveLocal();
            },

            'buy field': () => {
                if (game.money < game.prices.wheatField) {
                    print(`‚ùå Nicht genug Geld! (ben√∂tigt: ${game.prices.wheatField}‚Ç¨)`, 'error');
                    return;
                }
                game.money -= game.prices.wheatField;
                game.wheatFields++;
                print(`‚úì Weizenfeld gekauft! (Jetzt: ${game.wheatFields})`, 'success');
                updateDisplay();
                saveLocal();
            },

            'buy tree': () => {
                if (game.money < game.prices.appleTree) {
                    print(`‚ùå Nicht genug Geld! (ben√∂tigt: ${game.prices.appleTree}‚Ç¨)`, 'error');
                    return;
                }
                game.money -= game.prices.appleTree;
                game.appleTrees++;
                print(`‚úì Apfelbaum gekauft! (Jetzt: ${game.appleTrees})`, 'success');
                updateDisplay();
                saveLocal();
            },

            'buy mill': () => {
                if (game.money < game.prices.mill) {
                    print(`‚ùå Nicht genug Geld! (ben√∂tigt: ${game.prices.mill}‚Ç¨)`, 'error');
                    return;
                }
                game.money -= game.prices.mill;
                game.mills++;
                print(`‚úì M√ºhle gekauft! (Jetzt: ${game.mills})`, 'success');
                updateDisplay();
                saveLocal();
            },

            status: openStatus,
            inventory: openInventory,
            settings: openSettings,
            tutorial: showTutorial,

            prices: () => {
                print('üí∞ PREIS√úBERSICHT:', 'info');
                print('');
                print('üåæ WEIZEN:');
                print('  Pflanzen: 2‚Ç¨  |  Verkaufen: 8‚Ç¨  |  Zeit: 30s');
                print('üçé √ÑPFEL:');
                print('  Pflanzen: 5‚Ç¨  |  Verkaufen: 15‚Ç¨  |  Zeit: 60s');
                print('üè∫ MEHL:');
                print('  Kosten: 3 Weizen  |  Verkaufen: 25‚Ç¨  |  Zeit: 120s');
                print('');
                print('üèóÔ∏è GEB√ÑUDE:');
                print('  Weizenfeld: 100‚Ç¨');
                print('  Apfelbaum: 200‚Ç¨');
                print('  M√ºhle: 400‚Ç¨');
                print('');
            },

            login: githubLogin,
            logout: logout,
            backup: backupToCloud,
            restore: restoreFromCloud,

            clear: () => {
                terminal.innerHTML = '';
            }
        };

        // ============================================
        // INPUT HANDLER
        // ============================================

        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const command = input.value.trim().toLowerCase();
                
                if (command) {
                    print(`farm@terminal:~$ ${command}`, 'info');
                    
                    if (commands[command]) {
                        commands[command]();
                    } else {
                        print(`‚ùå Unbekannter Befehl: "${command}"`, 'error');
                        print('Tippe "help" f√ºr alle Befehle', 'warning');
                    }
                    
                    print('');
                }
                
                input.value = '';
            }
        });

        // ============================================
        // EVENT LISTENERS
        // ============================================

        document.getElementById('statusBtn').addEventListener('click', openStatus);
        document.getElementById('closeStatusBtn').addEventListener('click', closeStatus);
        document.getElementById('inventoryBtn').addEventListener('click', openInventory);
        document.getElementById('closeInventoryBtn').addEventListener('click', closeInventory);
        document.getElementById('settingsBtn').addEventListener('click', openSettings);

        // Close modals on background click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });

        // Online/Offline detection
        window.addEventListener('online', () => {
            isOnline = true;
            updateSyncBadge();
            print('‚úì Online-Verbindung wiederhergestellt', 'success');
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            updateSyncBadge();
            print('‚ö† Offline-Modus aktiviert', 'warning');
        });

        // Screen resize detection
        window.addEventListener('resize', updateAccessControl);

        // ============================================
        // INITIALIZATION
        // ============================================

        function init() {
            if (!updateAccessControl()) {
                return;
            }

            loadLocal();
            updateDisplay();
            
            print('üåæ TERMINAL FARM v3.0 üåæ', 'success');
            print('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'success');
            print('');
            
            if (!game.tutorialCompleted) {
                print('üëã Willkommen bei Terminal Farm!', 'info');
                print('√ñffne das Tutorial mit "tutorial" oder tippe "help"', 'warning');
                print('');
            } else {
                print('‚úì Spiel geladen!', 'success');
                print('Tippe "help" f√ºr alle Befehle', 'info');
                print('');
            }

            // Auto-save every 10 seconds
            setInterval(saveLocal, 10000);
        }

        // Auth state observer
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                updateSyncBadge();
            } else {
                currentUser = null;
                lastCloudBackup = 0;
                updateSyncBadge();
            }
        });

        // Start game
        init();
    </script>
</body>
</html>
