<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terminal Farm</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #0a0a0a;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #header {
            padding: 15px 20px;
            border-bottom: 2px solid #00ff00;
            background: #000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .title {
            font-size: 18px;
            font-weight: bold;
            color: #00ff00;
        }

        #money-display {
            font-size: 20px;
            font-weight: bold;
            color: #ffaa00;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            background: #001100;
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 8px 15px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #00ff00;
            color: #000;
        }

        #terminal {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            font-size: 14px;
            line-height: 1.6;
        }

        #terminal::-webkit-scrollbar {
            width: 10px;
        }

        #terminal::-webkit-scrollbar-track {
            background: #0a0a0a;
        }

        #terminal::-webkit-scrollbar-thumb {
            background: #00ff00;
        }

        .output-line {
            margin: 5px 0;
        }

        .success {
            color: #00ff00;
        }

        .error {
            color: #ff0000;
        }

        .warning {
            color: #ffaa00;
        }

        .info {
            color: #00aaff;
        }

        #input-line {
            display: flex;
            padding: 15px 20px;
            border-top: 2px solid #00ff00;
            background: #000;
        }

        #prompt {
            color: #00ff00;
            margin-right: 10px;
        }

        #input {
            flex: 1;
            background: transparent;
            border: none;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            outline: none;
        }

        .growing {
            color: #ffaa00;
        }

        .ready {
            color: #00ff00;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #0a0a0a;
            border: 2px solid #00ff00;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content::-webkit-scrollbar {
            width: 10px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: #0a0a0a;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: #00ff00;
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #00ff00;
            text-align: center;
        }

        .modal-item {
            padding: 10px;
            border: 1px solid #00ff00;
            margin-bottom: 10px;
            background: #001100;
        }

        .close-modal {
            margin-top: 20px;
            width: 100%;
        }

        .sync-status {
            font-size: 12px;
            color: #00aaff;
        }

        .sync-status.offline {
            color: #ff0000;
        }

        .sync-status.online {
            color: #00ff00;
        }

        .tutorial-step {
            background: #001100;
            border: 2px solid #ffaa00;
            padding: 20px;
            margin: 10px 0;
        }

        .tutorial-step h3 {
            color: #ffaa00;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div id="header">
        <div class="title">ğŸŒ¾ TERMINAL FARM v2.0 ğŸŒ¾</div>
        <div id="money-display">ğŸ’° 0 â‚¬</div>
        <div class="header-buttons">
            <span class="sync-status" id="syncStatus">â—</span>
            <button class="btn" onclick="openInventory()">ğŸ“¦ Inventar</button>
            <button class="btn" onclick="openSettings()">âš™ï¸ Einstellungen</button>
        </div>
    </div>

    <div id="terminal"></div>

    <div id="input-line">
        <span id="prompt">farm@terminal:~$</span>
        <input type="text" id="input" autocomplete="off" autofocus>
    </div>

    <!-- Inventory Modal -->
    <div id="inventoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">ğŸ“¦ INVENTAR</div>
            <div id="inventoryContent"></div>
            <button class="btn close-modal" onclick="closeInventory()">SchlieÃŸen</button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">âš™ï¸ EINSTELLUNGEN</div>
            <div id="settingsContent"></div>
            <button class="btn close-modal" onclick="closeSettings()">SchlieÃŸen</button>
        </div>
    </div>

    <!-- Tutorial Modal -->
    <div id="tutorialModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">ğŸ“ WILLKOMMEN BEI TERMINAL FARM!</div>
            <div id="tutorialContent"></div>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GithubAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDPiVhUPuJXhRRjbrftX67IBi2S7B_E3ps",
            authDomain: "term-farm.firebaseapp.com",
            projectId: "term-farm",
            storageBucket: "term-farm.firebasestorage.app",
            messagingSenderId: "319818614073",
            appId: "1:319818614073:web:5f348158b015c3378054e8",
            measurementId: "G-19VJCT6SPG"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GithubAuthProvider();

        // Game State
        const game = {
            money: 50,
            wheat: 0,
            apples: 0,
            flour: 0,
            wheatFields: 3,
            appleTrees: 2,
            mills: 1,
            wheatGrowing: [],
            applesGrowing: [],
            flourProducing: [],
            tutorialCompleted: false,
            tutorialStep: 0,
            prices: {
                wheat: 8,
                apple: 15,
                flour: 25,
                wheatField: 100,
                appleTree: 200,
                mill: 400
            },
            growthTimes: {
                wheat: 30000,
                apple: 60000,
                flour: 120000
            }
        };

        let currentUser = null;
        let isOnline = navigator.onLine;
        let lastSync = Date.now();

        // Terminal elements
        const terminal = document.getElementById('terminal');
        const input = document.getElementById('input');
        const moneyDisplay = document.getElementById('money-display');
        const syncStatus = document.getElementById('syncStatus');

        // Window functions
        window.openInventory = openInventory;
        window.closeInventory = closeInventory;
        window.openSettings = openSettings;
        window.closeSettings = closeSettings;
        window.githubLogin = githubLogin;
        window.logout = logout;

        // Print function
        function print(text, className = '') {
            const line = document.createElement('div');
            line.className = 'output-line ' + className;
            line.textContent = text;
            terminal.appendChild(line);
            terminal.scrollTop = terminal.scrollHeight;
        }

        // Update display
        function updateDisplay() {
            moneyDisplay.textContent = `ğŸ’° ${game.money} â‚¬`;
            updateSyncStatus();
        }

        // Update sync status
        function updateSyncStatus() {
            if (!isOnline) {
                syncStatus.className = 'sync-status offline';
                syncStatus.textContent = 'â— Offline';
            } else if (currentUser) {
                syncStatus.className = 'sync-status online';
                syncStatus.textContent = 'â— Online';
            } else {
                syncStatus.className = 'sync-status';
                syncStatus.textContent = 'â— Lokal';
            }
        }

        // Save to localStorage
        function saveLocal() {
            const data = {
                ...game,
                wheatGrowing: game.wheatGrowing.map(item => ({
                    elapsed: Date.now() - item.startTime
                })),
                applesGrowing: game.applesGrowing.map(item => ({
                    elapsed: Date.now() - item.startTime
                })),
                flourProducing: game.flourProducing.map(item => ({
                    elapsed: Date.now() - item.startTime
                }))
            };
            localStorage.setItem('terminalFarmSave', JSON.stringify(data));
        }

        // Load from localStorage
        function loadLocal() {
            const saved = localStorage.getItem('terminalFarmSave');
            if (saved) {
                const data = JSON.parse(saved);
                Object.assign(game, data);
                game.wheatGrowing = (game.wheatGrowing || []).map(item => ({
                    startTime: Date.now() - (item.elapsed || 0)
                }));
                game.applesGrowing = (game.applesGrowing || []).map(item => ({
                    startTime: Date.now() - (item.elapsed || 0)
                }));
                game.flourProducing = (game.flourProducing || []).map(item => ({
                    startTime: Date.now() - (item.elapsed || 0)
                }));
            }
        }

        // Save to Firestore
        async function saveToFirestore() {
            if (!currentUser) return;
            
            try {
                const data = {
                    ...game,
                    wheatGrowing: game.wheatGrowing.map(item => ({
                        elapsed: Date.now() - item.startTime
                    })),
                    applesGrowing: game.applesGrowing.map(item => ({
                        elapsed: Date.now() - item.startTime
                    })),
                    flourProducing: game.flourProducing.map(item => ({
                        elapsed: Date.now() - item.startTime
                    })),
                    lastUpdate: Date.now()
                };
                
                await setDoc(doc(db, "farms", currentUser.uid), data);
                lastSync = Date.now();
                print('âœ“ Cloud-Synchronisation erfolgreich', 'success');
            } catch (error) {
                print('âŒ Cloud-Sync fehlgeschlagen: ' + error.message, 'error');
            }
        }

        // Load from Firestore
        async function loadFromFirestore() {
            if (!currentUser) return;
            
            try {
                const docRef = doc(db, "farms", currentUser.uid);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    Object.assign(game, data);
                    game.wheatGrowing = (game.wheatGrowing || []).map(item => ({
                        startTime: Date.now() - (item.elapsed || 0)
                    }));
                    game.applesGrowing = (game.applesGrowing || []).map(item => ({
                        startTime: Date.now() - (item.elapsed || 0)
                    }));
                    game.flourProducing = (game.flourProducing || []).map(item => ({
                        startTime: Date.now() - (item.elapsed || 0)
                    }));
                    print('âœ“ Cloud-Daten geladen', 'success');
                } else {
                    // Erste Synchronisation
                    await saveToFirestore();
                }
            } catch (error) {
                print('âŒ Cloud-Load fehlgeschlagen: ' + error.message, 'error');
            }
        }

        // GitHub Login
        async function githubLogin() {
            try {
                const result = await signInWithPopup(auth, provider);
                currentUser = result.user;
                print(`âœ“ Eingeloggt als: ${currentUser.displayName || currentUser.email}`, 'success');
                print('Synchronisiere mit Cloud...', 'info');
                await loadFromFirestore();
                updateDisplay();
            } catch (error) {
                print('âŒ Login fehlgeschlagen: ' + error.message, 'error');
            }
        }

        // Logout
        async function logout() {
            try {
                await signOut(auth);
                currentUser = null;
                print('âœ“ Ausgeloggt', 'success');
                updateDisplay();
            } catch (error) {
                print('âŒ Logout fehlgeschlagen: ' + error.message, 'error');
            }
        }

        // Modals
        function openInventory() {
            const modal = document.getElementById('inventoryModal');
            const content = document.getElementById('inventoryContent');
            
            content.innerHTML = `
                <div class="modal-item">
                    <strong>ğŸŒ¾ Weizen:</strong> ${game.wheat}
                </div>
                <div class="modal-item">
                    <strong>ğŸ Ã„pfel:</strong> ${game.apples}
                </div>
                <div class="modal-item">
                    <strong>ğŸº Mehl:</strong> ${game.flour}
                </div>
                <div class="modal-item">
                    <strong>ğŸŒ¾ Weizenfelder:</strong> ${game.wheatFields}
                </div>
                <div class="modal-item">
                    <strong>ğŸ ApfelbÃ¤ume:</strong> ${game.appleTrees}
                </div>
                <div class="modal-item">
                    <strong>âš™ï¸ MÃ¼hlen:</strong> ${game.mills}
                </div>
                <div class="modal-item">
                    <strong>ğŸŒ± Weizen wÃ¤chst:</strong> ${game.wheatGrowing.length}/${game.wheatFields}
                </div>
                <div class="modal-item">
                    <strong>ğŸŒ± Ã„pfel wachsen:</strong> ${game.applesGrowing.length}/${game.appleTrees}
                </div>
                <div class="modal-item">
                    <strong>âš™ï¸ Mehl produziert:</strong> ${game.flourProducing.length}/${game.mills}
                </div>
            `;
            
            modal.classList.add('active');
        }

        function closeInventory() {
            document.getElementById('inventoryModal').classList.remove('active');
        }

        function openSettings() {
            const modal = document.getElementById('settingsModal');
            const content = document.getElementById('settingsContent');
            
            if (currentUser) {
                content.innerHTML = `
                    <div class="modal-item">
                        <strong>ğŸ‘¤ Benutzer:</strong> ${currentUser.displayName || currentUser.email}
                    </div>
                    <div class="modal-item">
                        <strong>ğŸ“§ Email:</strong> ${currentUser.email || 'Nicht verfÃ¼gbar'}
                    </div>
                    <div class="modal-item">
                        <strong>ğŸ”— Status:</strong> <span style="color: #00ff00;">Mit GitHub verbunden</span>
                    </div>
                    <div class="modal-item">
                        <strong>â˜ï¸ Cloud-Sync:</strong> <span style="color: #00ff00;">Aktiv</span>
                    </div>
                    <button class="btn" style="width: 100%; margin-top: 10px;" onclick="logout()">Ausloggen</button>
                `;
            } else {
                content.innerHTML = `
                    <div class="modal-item">
                        <strong>ğŸ”— Status:</strong> <span style="color: #ffaa00;">Nicht verbunden</span>
                    </div>
                    <div class="modal-item">
                        <strong>ğŸ’¾ Speicherung:</strong> <span style="color: #ffaa00;">Nur lokal</span>
                    </div>
                    <div class="modal-item" style="padding: 20px; text-align: center;">
                        <p style="margin-bottom: 15px; color: #00aaff;">
                            Verbinde dich mit GitHub, um deine Daten sicher in der Cloud zu speichern!
                        </p>
                        <button class="btn" style="width: 100%;" onclick="githubLogin()">ğŸ”— Mit GitHub verbinden</button>
                    </div>
                `;
            }
            
            modal.classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        // Tutorial
        function startTutorial() {
            const modal = document.getElementById('tutorialModal');
            const content = document.getElementById('tutorialContent');
            
            content.innerHTML = `
                <div class="tutorial-step">
                    <h3>Schritt 1: Felder bepflanzen ğŸŒ¾</h3>
                    <p>Tippe: <strong style="color: #ffaa00;">plant wheat 3</strong></p>
                    <p>Dies pflanzt Weizen auf 3 deiner Felder. Weizen wÃ¤chst 30 Sekunden.</p>
                </div>
                
                <div class="tutorial-step">
                    <h3>Schritt 2: Ernten ğŸ“¦</h3>
                    <p>Warte 30 Sekunden und tippe: <strong style="color: #ffaa00;">harvest all</strong></p>
                    <p>Dies erntet alle fertigen Pflanzen.</p>
                </div>
                
                <div class="tutorial-step">
                    <h3>Schritt 3: Verkaufen ğŸ’°</h3>
                    <p>Tippe: <strong style="color: #ffaa00;">sell all</strong></p>
                    <p>Dies verkauft alles in deinem Inventar und bringt dir Geld!</p>
                </div>
                
                <div class="tutorial-step">
                    <h3>Schritt 4: Erweitern ğŸ—ï¸</h3>
                    <p>Tippe: <strong style="color: #ffaa00;">buy field</strong></p>
                    <p>Kaufe mehr Felder, BÃ¤ume und MÃ¼hlen um zu wachsen!</p>
                </div>
                
                <div class="tutorial-step">
                    <h3>Weitere Befehle ğŸ“‹</h3>
                    <p>Tippe: <strong style="color: #ffaa00;">help</strong></p>
                    <p>FÃ¼r eine vollstÃ¤ndige Liste aller Befehle.</p>
                </div>
                
                <button class="btn close-modal" onclick="closeTutorial()" style="width: 100%;">
                    Los geht's! ğŸš€
                </button>
            `;
            
            modal.classList.add('active');
        }

        window.closeTutorial = function() {
            document.getElementById('tutorialModal').classList.remove('active');
            game.tutorialCompleted = true;
            saveLocal();
            print('âœ“ Tutorial abgeschlossen! Viel Erfolg! ğŸ‰', 'success');
            print('');
        };

        // Commands
        const commands = {
            help: () => {
                print('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—', 'info');
                print('â•‘              VERFÃœGBARE BEFEHLE                  â•‘', 'info');
                print('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
                print('');
                print('ğŸŒ± ANBAUEN:', 'success');
                print('  plant wheat [anzahl]  - Weizen anpflanzen (30s)');
                print('  plant apple [anzahl]  - Ã„pfel anpflanzen (60s)');
                print('  produce flour [anzahl] - Mehl herstellen (120s, kostet 2 Weizen)');
                print('');
                print('ğŸ“¦ ERNTEN:', 'success');
                print('  harvest wheat [anzahl] - Weizen ernten');
                print('  harvest apple [anzahl] - Ã„pfel ernten');
                print('  harvest flour [anzahl] - Mehl einsammeln');
                print('  harvest all           - Alles fertige ernten');
                print('');
                print('ğŸ’° VERKAUFEN:', 'success');
                print('  sell wheat [anzahl]   - Weizen verkaufen (8â‚¬)');
                print('  sell apple [anzahl]   - Ã„pfel verkaufen (15â‚¬)');
                print('  sell flour [anzahl]   - Mehl verkaufen (25â‚¬)');
                print('  sell all              - Alles verkaufen');
                print('');
                print('ğŸ—ï¸ KAUFEN:', 'success');
                print('  buy field [anzahl]    - Weizenfeld kaufen (100â‚¬)');
                print('  buy tree [anzahl]     - Apfelbaum kaufen (200â‚¬)');
                print('  buy mill [anzahl]     - MÃ¼hle kaufen (400â‚¬)');
                print('');
                print('ğŸ“Š INFO:', 'success');
                print('  status    - Zeige Farm-Status');
                print('  prices    - Zeige Preise');
                print('  growing   - Zeige wachsende Pflanzen');
                print('  login     - Mit GitHub einloggen');
                print('  tutorial  - Tutorial erneut anzeigen');
                print('  clear     - Bildschirm leeren');
                print('');
            },

            login: () => {
                if (currentUser) {
                    print('Du bist bereits eingeloggt!', 'warning');
                    print(`Benutzer: ${currentUser.displayName || currentUser.email}`, 'info');
                } else {
                    print('MÃ¶chtest du dich mit GitHub verbinden?', 'info');
                    print('Deine Daten werden dann sicher in der Cloud gespeichert.', 'info');
                    print('');
                    print('Ã–ffne die Einstellungen (âš™ï¸ Button oben rechts) zum Einloggen!', 'warning');
                }
            },

            tutorial: () => {
                startTutorial();
            },

            status: () => {
                print('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—', 'info');
                print('â•‘              FARM STATUS                         â•‘', 'info');
                print('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
                print('');
                print(`ğŸ’° Geld: ${game.money} â‚¬`, 'success');
                print('');
                print('ğŸ“¦ LAGER:', 'warning');
                print(`  ğŸŒ¾ Weizen: ${game.wheat}`);
                print(`  ğŸ Ã„pfel: ${game.apples}`);
                print(`  ğŸº Mehl: ${game.flour}`);
                print('');
                print('ğŸ—ï¸ GEBÃ„UDE:', 'warning');
                print(`  ğŸŒ¾ Weizenfelder: ${game.wheatFields}`);
                print(`  ğŸ ApfelbÃ¤ume: ${game.appleTrees}`);
                print(`  âš™ï¸ MÃ¼hlen: ${game.mills}`);
                print('');
                print('ğŸŒ± AKTIV:', 'warning');
                print(`  Weizen wÃ¤chst: ${game.wheatGrowing.length}/${game.wheatFields}`);
                print(`  Ã„pfel wachsen: ${game.applesGrowing.length}/${game.appleTrees}`);
                print(`  Mehl produziert: ${game.flourProducing.length}/${game.mills}`);
                print('');
            },

            prices: () => {
                print('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—', 'info');
                print('â•‘              MARKTPREISE                         â•‘', 'info');
                print('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
                print('');
                print('ğŸ’° VERKAUFSPREISE:', 'success');
                print(`  ğŸŒ¾ Weizen: ${game.prices.wheat} â‚¬`);
                print(`  ğŸ Apfel: ${game.prices.apple} â‚¬`);
                print(`  ğŸº Mehl: ${game.prices.flour} â‚¬`);
                print('');
                print('ğŸ—ï¸ KAUFPREISE:', 'warning');
                print(`  ğŸŒ¾ Weizenfeld: ${game.prices.wheatField} â‚¬`);
                print(`  ğŸ Apfelbaum: ${game.prices.appleTree} â‚¬`);
                print(`  âš™ï¸ MÃ¼hle: ${game.prices.mill} â‚¬`);
                print('');
            },

            growing: () => {
                print('ğŸŒ± WACHSTUMS-STATUS:', 'info');
                print('');
                
                if (game.wheatGrowing.length > 0) {
                    print(`ğŸŒ¾ WEIZEN (${game.wheatGrowing.length}):`, 'success');
                    game.wheatGrowing.forEach((item, i) => {
                        const elapsed = Date.now() - item.startTime;
                        const remaining = Math.max(0, Math.ceil((game.growthTimes.wheat - elapsed) / 1000));
                        if (remaining > 0) {
                            print(`  [${i+1}] Noch ${remaining}s...`, 'growing');
                        } else {
                            print(`  [${i+1}] âœ“ FERTIG!`, 'ready');
                        }
                    });
                    print('');
                }

                if (game.applesGrowing.length > 0) {
                    print(`ğŸ Ã„PFEL (${game.applesGrowing.length}):`, 'success');
                    game.applesGrowing.forEach((item, i) => {
                        const elapsed = Date.now() - item.startTime;
                        const remaining = Math.max(0, Math.ceil((game.growthTimes.apple - elapsed) / 1000));
                        if (remaining > 0) {
                            print(`  [${i+1}] Noch ${remaining}s...`, 'growing');
                        } else {
                            print(`  [${i+1}] âœ“ FERTIG!`, 'ready');
                        }
                    });
                    print('');
                }

                if (game.flourProducing.length > 0) {
                    print(`ğŸº MEHL (${game.flourProducing.length}):`, 'success');
                    game.flourProducing.forEach((item, i) => {
                        const elapsed = Date.now() - item.startTime;
                        const remaining = Math.max(0, Math.ceil((game.growthTimes.flour - elapsed) / 1000));
                        if (remaining > 0) {
                            print(`  [${i+1}] Noch ${remaining}s...`, 'growing');
                        } else {
                            print(`  [${i+1}] âœ“ FERTIG!`, 'ready');
                        }
                    });
                    print('');
                }

                if (game.wheatGrowing.length === 0 && game.applesGrowing.length === 0 && game.flourProducing.length === 0) {
                    print('Nichts wÃ¤chst gerade.', 'warning');
                    print('');
                }
            },

            plant: (args) => {
                const type = args[0];
                let amount = 1;
                if (args.length > 1) {
                    const parsed = parseInt(args[1]);
                    if (isNaN(parsed) || parsed < 1) {
                        print('âŒ UngÃ¼ltige Anzahl!', 'error');
                        return;
                    }
                    amount = parsed;
                }

                if (type === 'wheat') {
                    const available = game.wheatFields - game.wheatGrowing.length;
                    if (amount > available) {
                        print(`âŒ Nur ${available} Felder verfÃ¼gbar!`, 'error');
                        return;
                    }
                    for (let i = 0; i < amount; i++) {
                        game.wheatGrowing.push({ startTime: Date.now() });
                    }
                    print(`âœ“ ${amount}x Weizen angepflanzt! (30s)`, 'success');
                } else if (type === 'apple') {
                    const available = game.appleTrees - game.applesGrowing.length;
                    if (amount > available) {
                        print(`âŒ Nur ${available} BÃ¤ume verfÃ¼gbar!`, 'error');
                        return;
                    }
                    for (let i = 0; i < amount; i++) {
                        game.applesGrowing.push({ startTime: Date.now() });
                    }
                    print(`âœ“ ${amount}x Ã„pfel angepflanzt! (60s)`, 'success');
                } else {
                    print('âŒ Unbekannter Typ! Nutze: wheat oder apple', 'error');
                    return;
                }
                saveLocal();
                updateDisplay();
            },

            produce: (args) => {
                const type = args[0];
                let amount = 1;
                if (args.length > 1) {
                    const parsed = parseInt(args[1]);
                    if (isNaN(parsed) || parsed < 1) {
                        print('âŒ UngÃ¼ltige Anzahl!', 'error');
                        return;
                    }
                    amount = parsed;
                }

                if (type === 'flour') {
                    const available = game.mills - game.flourProducing.length;
                    if (amount > available) {
                        print(`âŒ Nur ${available} MÃ¼hlen verfÃ¼gbar!`, 'error');
                        return;
                    }
                    const wheatNeeded = amount * 2;
                    if (game.wheat < wheatNeeded) {
                        print(`âŒ Du brauchst ${wheatNeeded} Weizen! (Du hast ${game.wheat})`, 'error');
                        return;
                    }
                    game.wheat -= wheatNeeded;
                    for (let i = 0; i < amount; i++) {
                        game.flourProducing.push({ startTime: Date.now() });
                    }
                    print(`âœ“ ${amount}x Mehl wird produziert! (120s, -${wheatNeeded} Weizen)`, 'success');
                } else {
                    print('âŒ Unbekannter Typ! Nutze: flour', 'error');
                    return;
                }
                saveLocal();
                updateDisplay();
            },

            harvest: (args) => {
                const type = args[0];

                if (type === 'all') {
                    const readyWheat = game.wheatGrowing.filter(item => 
                        Date.now() - item.startTime >= game.growthTimes.wheat
                    );
                    game.wheat += readyWheat.length;
                    game.wheatGrowing = game.wheatGrowing.filter(item => 
                        Date.now() - item.startTime < game.growthTimes.wheat
                    );
                    if (readyWheat.length > 0) print(`âœ“ ${readyWheat.length}x Weizen geerntet!`, 'success');

                    const readyApples = game.applesGrowing.filter(item => 
                        Date.now() - item.startTime >= game.growthTimes.apple
                    );
                    game.apples += readyApples.length;
                    game.applesGrowing = game.applesGrowing.filter(item => 
                        Date.now() - item.startTime < game.growthTimes.apple
                    );
                    if (readyApples.length > 0) print(`âœ“ ${readyApples.length}x Ã„pfel geerntet!`, 'success');

                    const readyFlour = game.flourProducing.filter(item => 
                        Date.now() - item.startTime >= game.growthTimes.flour
                    );
                    game.flour += readyFlour.length;
                    game.flourProducing = game.flourProducing.filter(item => 
                        Date.now() - item.startTime < game.growthTimes.flour
                    );
                    if (readyFlour.length > 0) print(`âœ“ ${readyFlour.length}x Mehl geerntet!`, 'success');

                    if (readyWheat.length + readyApples.length + readyFlour.length === 0) {
                        print('âŒ Nichts bereit zum Ernten!', 'error');
                    }
                } else if (type === 'wheat') {
                    let amount = 999999;
                    if (args.length > 1) {
                        const parsed = parseInt(args[1]);
                        if (isNaN(parsed) || parsed < 1) {
                            print('âŒ UngÃ¼ltige Anzahl!', 'error');
                            return;
                        }
                        amount = parsed;
                    }
                    
                    const readyWheat = game.wheatGrowing.filter(item => 
                        Date.now() - item.startTime >= game.growthTimes.wheat
                    ).slice(0, amount);
                    
                    if (readyWheat.length === 0) {
                        print('âŒ Kein Weizen bereit zum Ernten!', 'error');
                        return;
                    }
                    
                    game.wheat += readyWheat.length;
                    game.wheatGrowing = game.wheatGrowing.filter(item => 
                        !readyWheat.includes(item)
                    );
                    print(`âœ“ ${readyWheat.length}x Weizen geerntet!`, 'success');
                } else if (type === 'apple') {
                    let amount = 999999;
                    if (args.length > 1) {
                        const parsed = parseInt(args[1]);
                        if (isNaN(parsed) || parsed < 1) {
                            print('âŒ UngÃ¼ltige Anzahl!', 'error');
                            return;
                        }
                        amount = parsed;
                    }
                    
                    const readyApples = game.applesGrowing.filter(item => 
                        Date.now() - item.startTime >= game.growthTimes.apple
                    ).slice(0, amount);
                    
                    if (readyApples.length === 0) {
                        print('âŒ Keine Ã„pfel bereit zum Ernten!', 'error');
                        return;
                    }
                    
                    game.apples += readyApples.length;
                    game.applesGrowing = game.applesGrowing.filter(item => 
                        !readyApples.includes(item)
                    );
                    print(`âœ“ ${readyApples.length}x Ã„pfel geerntet!`, 'success');
                } else if (type === 'flour') {
                    let amount = 999999;
                    if (args.length > 1) {
                        const parsed = parseInt(args[1]);
                        if (isNaN(parsed) || parsed < 1) {
                            print('âŒ UngÃ¼ltige Anzahl!', 'error');
                            return;
                        }
                        amount = parsed;
                    }
                    
                    const readyFlour = game.flourProducing.filter(item => 
                        Date.now() - item.startTime >= game.growthTimes.flour
                    ).slice(0, amount);
                    
                    if (readyFlour.length === 0) {
                        print('âŒ Kein Mehl bereit zum Ernten!', 'error');
                        return;
                    }
                    
                    game.flour += readyFlour.length;
                    game.flourProducing = game.flourProducing.filter(item => 
                        !readyFlour.includes(item)
                    );
                    print(`âœ“ ${readyFlour.length}x Mehl geerntet!`, 'success');
                } else {
                    print('âŒ Unbekannter Typ! Nutze: wheat, apple, flour oder all', 'error');
                    return;
                }
                saveLocal();
                updateDisplay();
            },

            sell: (args) => {
                const type = args[0];

                if (type === 'all') {
                    const total = (game.wheat * game.prices.wheat) + 
                                (game.apples * game.prices.apple) + 
                                (game.flour * game.prices.flour);
                    if (total === 0) {
                        print('âŒ Nichts zum Verkaufen!', 'error');
                        return;
                    }
                    print(`âœ“ Verkauft: ${game.wheat} Weizen, ${game.apples} Ã„pfel, ${game.flour} Mehl`, 'success');
                    print(`ğŸ’° +${total} â‚¬ erhalten!`, 'success');
                    game.money += total;
                    game.wheat = 0;
                    game.apples = 0;
                    game.flour = 0;
                } else if (type === 'wheat') {
                    let amount = game.wheat;
                    if (args.length > 1) {
                        const parsed = parseInt(args[1]);
                        if (isNaN(parsed) || parsed < 1) {
                            print('âŒ UngÃ¼ltige Anzahl!', 'error');
                            return;
                        }
                        amount = parsed;
                    }
                    
                    if (amount > game.wheat) {
                        print(`âŒ Du hast nur ${game.wheat} Weizen!`, 'error');
                        return;
                    }
                    const earned = amount * game.prices.wheat;
                    game.wheat -= amount;
                    game.money += earned;
                    print(`âœ“ ${amount}x Weizen verkauft! (+${earned} â‚¬)`, 'success');
                } else if (type === 'apple') {
                    let amount = game.apples;
                    if (args.length > 1) {
                        const parsed = parseInt(args[1]);
                        if (isNaN(parsed) || parsed < 1) {
                            print('âŒ UngÃ¼ltige Anzahl!', 'error');
                            return;
                        }
                        amount = parsed;
                    }
                    
                    if (amount > game.apples) {
                        print(`âŒ Du hast nur ${game.apples} Ã„pfel!`, 'error');
                        return;
                    }
                    const earned = amount * game.prices.apple;
                    game.apples -= amount;
                    game.money += earned;
                    print(`âœ“ ${amount}x Ã„pfel verkauft! (+${earned} â‚¬)`, 'success');
                } else if (type === 'flour') {
                    let amount = game.flour;
                    if (args.length > 1) {
                        const parsed = parseInt(args[1]);
                        if (isNaN(parsed) || parsed < 1) {
                            print('âŒ UngÃ¼ltige Anzahl!', 'error');
                            return;
                        }
                        amount = parsed;
                    }
                    
                    if (amount > game.flour) {
                        print(`âŒ Du hast nur ${game.flour} Mehl!`, 'error');
                        return;
                    }
                    const earned = amount * game.prices.flour;
                    game.flour -= amount;
                    game.money += earned;
                    print(`âœ“ ${amount}x Mehl verkauft! (+${earned} â‚¬)`, 'success');
                } else {
                    print('âŒ Unbekannter Typ! Nutze: wheat, apple, flour oder all', 'error');
                    return;
                }
                saveLocal();
                updateDisplay();
            },

            buy: (args) => {
                const type = args[0];
                let amount = 1;
                if (args.length > 1) {
                    const parsed = parseInt(args[1]);
                    if (isNaN(parsed) || parsed < 1) {
                        print('âŒ UngÃ¼ltige Anzahl!', 'error');
                        return;
                    }
                    amount = parsed;
                }

                if (type === 'field') {
                    const totalCost = game.prices.wheatField * amount;
                    if (game.money < totalCost) {
                        print(`âŒ Nicht genug Geld! BenÃ¶tigt: ${totalCost} â‚¬ (hast ${game.money} â‚¬)`, 'error');
                        return;
                    }
                    game.money -= totalCost;
                    game.wheatFields += amount;
                    print(`âœ“ ${amount}x Weizenfeld gekauft! (-${totalCost} â‚¬)`, 'success');
                } else if (type === 'tree') {
                    const totalCost = game.prices.appleTree * amount;
                    if (game.money < totalCost) {
                        print(`âŒ Nicht genug Geld! BenÃ¶tigt: ${totalCost} â‚¬ (hast ${game.money} â‚¬)`, 'error');
                        return;
                    }
                    game.money -= totalCost;
                    game.appleTrees += amount;
                    print(`âœ“ ${amount}x Apfelbaum gekauft! (-${totalCost} â‚¬)`, 'success');
                } else if (type === 'mill') {
                    const totalCost = game.prices.mill * amount;
                    if (game.money < totalCost) {
                        print(`âŒ Nicht genug Geld! BenÃ¶tigt: ${totalCost} â‚¬ (hast ${game.money} â‚¬)`, 'error');
                        return;
                    }
                    game.money -= totalCost;
                    game.mills += amount;
                    print(`âœ“ ${amount}x MÃ¼hle gekauft! (-${totalCost} â‚¬)`, 'success');
                } else {
                    print('âŒ Unbekannter Typ! Nutze: field, tree oder mill', 'error');
                    return;
                }
                saveLocal();
                updateDisplay();
            },

            clear: () => {
                terminal.innerHTML = '';
            }
        };

        // Process command
        function processCommand(cmd) {
            print(`farm@terminal:~$ ${cmd}`, 'info');
            
            const parts = cmd.trim().toLowerCase().split(/\s+/);
            const command = parts[0];
            const args = parts.slice(1);

            if (commands[command]) {
                commands[command](args);
            } else if (cmd.trim() === '') {
                // Do nothing
            } else {
                print(`âŒ Befehl nicht gefunden: ${command}`, 'error');
                print('Tippe "help" fÃ¼r alle Befehle.', 'warning');
            }
            print('');
        }

        // Input handling
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const cmd = input.value;
                input.value = '';
                processCommand(cmd);
            }
        });

        // Keep input focused
        document.addEventListener('click', () => {
            input.focus();
        });

        // Online/Offline detection
        window.addEventListener('online', () => {
            isOnline = true;
            updateSyncStatus();
            print('âœ“ Verbindung wiederhergestellt', 'success');
            if (currentUser) {
                loadFromFirestore();
            }
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            updateSyncStatus();
            print('âš ï¸ Offline-Modus', 'warning');
        });

        // Auth state observer
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                updateSyncStatus();
            } else {
                currentUser = null;
                updateSyncStatus();
            }
        });

        // Auto-save (local every 10s, cloud every 60s if online)
        setInterval(() => {
            saveLocal();
            if (currentUser && isOnline && Date.now() - lastSync > 60000) {
                saveToFirestore();
            }
        }, 10000);

        // Update display every second
        setInterval(updateDisplay, 1000);

        // Welcome message
        function printWelcome() {
            print('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
            print('   ğŸŒ¾ Willkommen bei TERMINAL FARM! ğŸŒ¾', 'info');
            print('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
            print('');
            print('Baue Pflanzen an, produziere Waren und verkaufe sie!', 'info');
            print('');
            print('Tippe "help" fÃ¼r alle Befehle oder "tutorial" fÃ¼r Hilfe!', 'warning');
            print('');
        }

        // Initialize
        loadLocal();
        updateDisplay();
        printWelcome();

        // Show tutorial for new players
        if (!game.tutorialCompleted) {
            setTimeout(startTutorial, 1000);
        }
    </script>
</body>
</html>
