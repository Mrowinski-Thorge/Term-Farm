<!DOCTYPE html>
<html lang="de">
<script>
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
            .then(reg => console.log('Service Worker registered'))
            .catch(err => console.log('Service Worker registration failed:', err));
    });
}
</script>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0a0a0a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Term-Farm">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>Terminal Farm - Befehlszeilen Farmspiel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            position: fixed;
            width: 100%;
        }

        body {
            background: #0a0a0a;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            display: flex;
            flex-direction: column;
        }

        /* Screen Size Warning */
        #screenWarning {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0a0a0a;
            z-index: 10000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
        }

        #screenWarning.active {
            display: flex;
        }

        .warning-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .warning-text {
            font-size: 20px;
            color: #ffaa00;
            margin-bottom: 10px;
        }

        .warning-subtext {
            font-size: 14px;
            color: #00aaff;
            max-width: 400px;
        }

        /* PWA Install Banner */
        #pwaInstallBanner {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #001100;
            border: 2px solid #00ff00;
            padding: 20px;
            border-radius: 10px;
            z-index: 9999;
            max-width: 90%;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 255, 0, 0.3);
        }

        #pwaInstallBanner.active {
            display: block;
        }

        .pwa-title {
            font-size: 18px;
            color: #00ff00;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .pwa-text {
            font-size: 14px;
            color: #00aaff;
            margin-bottom: 15px;
        }

        .pwa-benefits {
            text-align: left;
            margin: 15px 0;
            color: #ffaa00;
            font-size: 13px;
        }

        .pwa-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        #header {
            padding: 15px 20px;
            border-bottom: 2px solid #00ff00;
            background: #000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            flex-shrink: 0;
        }

        .title {
            font-size: 18px;
            font-weight: bold;
            color: #00ff00;
        }

        #money-display {
            font-size: 20px;
            font-weight: bold;
            color: #ffaa00;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            background: #001100;
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 8px 15px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .btn:hover {
            background: #00ff00;
            color: #000;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn.danger {
            border-color: #ff0000;
            color: #ff0000;
        }

        .btn.danger:hover {
            background: #ff0000;
            color: #fff;
        }

        #terminal {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
            font-size: 14px;
            line-height: 1.6;
            min-height: 0;
        }

        #terminal::-webkit-scrollbar {
            width: 10px;
        }

        #terminal::-webkit-scrollbar-track {
            background: #0a0a0a;
        }

        #terminal::-webkit-scrollbar-thumb {
            background: #00ff00;
        }

        .output-line {
            margin: 5px 0;
            word-wrap: break-word;
        }

        .success {
            color: #00ff00;
        }

        .error {
            color: #ff0000;
        }

        .warning {
            color: #ffaa00;
        }

        .info {
            color: #00aaff;
        }

        #input-line {
            display: flex;
            padding: 15px 20px;
            border-top: 2px solid #00ff00;
            background: #000;
            flex-shrink: 0;
        }

        #prompt {
            color: #00ff00;
            margin-right: 10px;
            flex-shrink: 0;
        }

        #input {
            flex: 1;
            background: transparent;
            border: none;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            outline: none;
            min-width: 0;
        }

        .growing {
            color: #ffaa00;
        }

        .ready {
            color: #00ff00;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            overflow: hidden;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #0a0a0a;
            border: 2px solid #00ff00;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content::-webkit-scrollbar {
            width: 10px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: #0a0a0a;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: #00ff00;
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #00ff00;
            text-align: center;
        }

        .modal-item {
            padding: 10px;
            border: 1px solid #00ff00;
            margin-bottom: 10px;
            background: #001100;
        }

        .close-modal {
            margin-top: 20px;
            width: 100%;
        }

        .sync-status {
            font-size: 12px;
            padding: 5px 10px;
            border: 1px solid;
            border-radius: 3px;
        }

        .sync-status.offline {
            color: #ff0000;
            border-color: #ff0000;
            background: #220000;
        }

        .sync-status.online {
            color: #00ff00;
            border-color: #00ff00;
            background: #002200;
        }

        .sync-status.syncing {
            color: #ffaa00;
            border-color: #ffaa00;
            background: #221100;
            animation: pulse 1s infinite;
        }

        .sync-status.local {
            color: #ffaa00;
            border-color: #ffaa00;
            background: #221100;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .tutorial-step {
            background: #001100;
            border: 2px solid #ffaa00;
            padding: 20px;
            margin: 10px 0;
        }

        .tutorial-step h3 {
            color: #ffaa00;
            margin-bottom: 10px;
        }

        .choice-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .choice-buttons .btn {
            flex: 1;
        }

        .status-item {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #00ff00;
            background: #001100;
        }

        .status-item-title {
            color: #ffaa00;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .status-item-content {
            color: #00ff00;
            margin-left: 10px;
        }

        .device-info {
            font-size: 12px;
            color: #00aaff;
            margin-top: 5px;
        }

        .save-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }

        .save-card {
            border: 2px solid #00ff00;
            padding: 15px;
            background: #001100;
        }

        .save-card.recommended {
            border-color: #ffaa00;
            box-shadow: 0 0 10px rgba(255, 170, 0, 0.5);
        }

        .save-card-title {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .save-stat {
            margin: 5px 0;
            font-size: 13px;
        }

        @media (max-width: 768px) {
            .save-comparison {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Screen Size Warning -->
    <div id="screenWarning">
        <div class="warning-icon">üì±‚ùå</div>
        <div class="warning-text">Bildschirm zu klein</div>
        <div class="warning-subtext">
            Terminal Farm kann auf diesem Ger√§t nicht genutzt werden.<br><br>
            Bitte verwende ein Tablet, iPad oder Computer f√ºr das beste Spielerlebnis.<br><br>
            Mindestens 768px Breite erforderlich.
        </div>
    </div>

    <!-- PWA Install Banner -->
    <div id="pwaInstallBanner">
        <div class="pwa-title">üåæ Terminal Farm installieren</div>
        <div class="pwa-text">
            Installiere Terminal Farm als App f√ºr das beste Erlebnis!
        </div>
        <div class="pwa-benefits">
            ‚úì Offline spielen<br>
            ‚úì Schneller Zugriff<br>
            ‚úì Automatische Synchronisation<br>
            ‚úì Wie eine native App
        </div>
        <div class="pwa-buttons">
            <button class="btn" id="installPWABtn">Jetzt installieren</button>
            <button class="btn" id="dismissPWABtn">Sp√§ter</button>
        </div>
    </div>

    <div id="header">
        <div class="title">üåæ TERMINAL FARM v2.1 üåæ</div>
        <div id="money-display">üí∞ 0 ‚Ç¨</div>
        <div class="header-buttons">
            <span class="sync-status local" id="syncStatus">‚óè Lokal</span>
            <button class="btn" id="statusBtn">üìä Status</button>
            <button class="btn" id="inventoryBtn">üì¶ Inventar</button>
            <button class="btn" id="settingsBtn">‚öôÔ∏è Einstellungen</button>
        </div>
    </div>

    <div id="terminal"></div>

    <div id="input-line">
        <span id="prompt">farm@terminal:~$</span>
        <input type="text" id="input" autocomplete="off" autofocus>
    </div>

    <!-- Status Modal -->
    <div id="statusModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">üìä FARM STATUS</div>
            <div id="statusContent"></div>
            <button class="btn close-modal" id="closeStatusBtn">Schlie√üen</button>
        </div>
    </div>

    <!-- Inventory Modal -->
    <div id="inventoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">üì¶ INVENTAR</div>
            <div id="inventoryContent"></div>
            <button class="btn close-modal" id="closeInventoryBtn">Schlie√üen</button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">‚öôÔ∏è EINSTELLUNGEN</div>
            <div id="settingsContent"></div>
            <button class="btn close-modal" id="closeSettingsBtn">Schlie√üen</button>
        </div>
    </div>

    <!-- Tutorial Modal -->
    <div id="tutorialModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">üéì WILLKOMMEN BEI TERMINAL FARM!</div>
            <div id="tutorialContent"></div>
        </div>
    </div>

    <!-- Login Choice Modal -->
    <div id="loginChoiceModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">‚òÅÔ∏è CLOUD-SPEICHERUNG</div>
            <div id="loginChoiceContent">
                <p style="margin-bottom: 20px; color: #00aaff;">
                    M√∂chtest du dich mit GitHub verbinden, um deine Daten in der Cloud zu speichern?
                </p>
                <p style="margin-bottom: 20px; color: #ffaa00;">
                    Vorteile:
                </p>
                <ul style="margin-left: 20px; margin-bottom: 20px; color: #00ff00;">
                    <li>‚úì Daten auf mehreren Ger√§ten synchronisieren</li>
                    <li>‚úì Sicheres Cloud-Backup</li>
                    <li>‚úì Offline-Spielstand wird gesch√ºtzt</li>
                </ul>
                <div class="choice-buttons">
                    <button class="btn" id="acceptLoginBtn">Mit GitHub verbinden</button>
                    <button class="btn" id="declineLoginBtn">Sp√§ter</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sync Conflict Modal -->
    <div id="syncConflictModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">‚ö†Ô∏è SPEICHERSTAND W√ÑHLEN</div>
            <div id="syncConflictContent"></div>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GithubAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDPiVhUPuJXhRRjbrftX67IBi2S7B_E3ps",
            authDomain: "term-farm.firebaseapp.com",
            projectId: "term-farm",
            storageBucket: "term-farm.firebasestorage.app",
            messagingSenderId: "319818614073",
            appId: "1:319818614073:web:5f348158b015c3378054e8",
            measurementId: "G-19VJCT6SPG"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GithubAuthProvider();

        // ============================================
        // DEVICE & PWA DETECTION
        // ============================================
        
        // Generate unique device ID
        function getDeviceId() {
            let deviceId = localStorage.getItem('termFarmDeviceId');
            if (!deviceId) {
                deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('termFarmDeviceId', deviceId);
            }
            return deviceId;
        }

        const DEVICE_ID = getDeviceId();

        // Check if running as installed PWA
        function isPWA() {
            return window.matchMedia('(display-mode: standalone)').matches || 
                   window.navigator.standalone === true ||
                   document.referrer.includes('android-app://');
        }

        const IS_PWA = isPWA();

        // Check screen size
        function checkScreenSize() {
            const minWidth = 768;
            const minHeight = 600;
            
            if (window.innerWidth < minWidth || window.innerHeight < minHeight) {
                document.getElementById('screenWarning').classList.add('active');
                return false;
            } else {
                document.getElementById('screenWarning').classList.remove('active');
                return true;
            }
        }

        // PWA Installation
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Only show if not already installed and user hasn't dismissed it recently
            if (!IS_PWA && !localStorage.getItem('pwaDismissed')) {
                setTimeout(() => {
                    document.getElementById('pwaInstallBanner').classList.add('active');
                }, 3000);
            }
        });

        document.getElementById('installPWABtn').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                
                if (outcome === 'accepted') {
                    print('‚úì App wird installiert...', 'success');
                }
                
                deferredPrompt = null;
                document.getElementById('pwaInstallBanner').classList.remove('active');
            }
        });

        document.getElementById('dismissPWABtn').addEventListener('click', () => {
            document.getElementById('pwaInstallBanner').classList.remove('active');
            localStorage.setItem('pwaDismissed', Date.now().toString());
        });

        // Check on load and resize
        checkScreenSize();
        window.addEventListener('resize', checkScreenSize);

        // ============================================
        // GAME STATE
        // ============================================
        
        let game = {
            money: 50,
            wheat: 0,
            apples: 0,
            flour: 0,
            wheatFields: 3,
            appleTrees: 2,
            mills: 1,
            wheatGrowing: [],
            applesGrowing: [],
            flourProducing: [],
            tutorialCompleted: false,
            loginChoiceShown: false,
            deviceId: DEVICE_ID,
            isPWA: IS_PWA,
            lastUpdate: Date.now(),
            playTime: 0,
            prices: {
                wheat: 8,
                apple: 15,
                flour: 25,
                wheatField: 100,
                appleTree: 200,
                mill: 400
            },
            growthTimes: {
                wheat: 30000,
                apple: 60000,
                flour: 120000
            }
        };

        let currentUser = null;
        let isOnline = navigator.onLine;
        let lastSync = 0;
        let isSyncing = false;
        let syncInterval = null;
        let pendingCloudData = null;
        let lastConnectionState = isOnline;
        let appStartTime = Date.now();

        // DOM Elements
        const terminal = document.getElementById('terminal');
        const input = document.getElementById('input');
        const moneyDisplay = document.getElementById('money-display');
        const syncStatus = document.getElementById('syncStatus');

        // Button listeners
        document.getElementById('statusBtn').addEventListener('click', openStatus);
        document.getElementById('inventoryBtn').addEventListener('click', openInventory);
        document.getElementById('settingsBtn').addEventListener('click', openSettings);
        document.getElementById('closeStatusBtn').addEventListener('click', closeStatus);
        document.getElementById('closeInventoryBtn').addEventListener('click', closeInventory);
        document.getElementById('closeSettingsBtn').addEventListener('click', closeSettings);
        document.getElementById('acceptLoginBtn').addEventListener('click', acceptLogin);
        document.getElementById('declineLoginBtn').addEventListener('click', declineLogin);

        // Prevent body scroll
        document.body.style.overflow = 'hidden';
        document.documentElement.style.overflow = 'hidden';

        // ============================================
        // PROFESSIONAL SYNC SYSTEM
        // ============================================

        // Print function
        function print(text, className = '') {
            const line = document.createElement('div');
            line.className = 'output-line ' + className;
            line.textContent = text;
            terminal.appendChild(line);
            terminal.scrollTop = terminal.scrollHeight;
        }

        // Update display
        function updateDisplay() {
            moneyDisplay.textContent = `üí∞ ${game.money} ‚Ç¨`;
            updateSyncStatus();
        }

        // Update sync status
        function updateSyncStatus() {
            if (isSyncing) {
                syncStatus.className = 'sync-status syncing';
                syncStatus.textContent = '‚ü≥ Sync...';
            } else if (!isOnline) {
                syncStatus.className = 'sync-status offline';
                syncStatus.textContent = '‚óè Offline';
            } else if (currentUser) {
                syncStatus.className = 'sync-status online';
                const lastSyncText = lastSync > 0 ? Math.floor((Date.now() - lastSync) / 1000) + 's' : '‚àû';
                syncStatus.textContent = `‚óè Online (${lastSyncText})`;
            } else {
                syncStatus.className = 'sync-status local';
                syncStatus.textContent = '‚óè Lokal';
            }
        }

        // Save to localStorage - ALWAYS
        function saveLocal() {
            try {
                game.lastUpdate = Date.now();
                game.deviceId = DEVICE_ID;
                game.isPWA = IS_PWA;
                
                const data = {
                    ...game,
                    wheatGrowing: game.wheatGrowing.map(item => ({
                        elapsed: Date.now() - item.startTime
                    })),
                    applesGrowing: game.applesGrowing.map(item => ({
                        elapsed: Date.now() - item.startTime
                    })),
                    flourProducing: game.flourProducing.map(item => ({
                        elapsed: Date.now() - item.startTime
                    })),
                    version: '2.1'
                };
                
                localStorage.setItem('terminalFarmSave', JSON.stringify(data));
            } catch (error) {
                console.error('Local save failed:', error);
            }
        }

        // Load from localStorage
        function loadLocal() {
            try {
                const saved = localStorage.getItem('terminalFarmSave');
                if (saved) {
                    const data = JSON.parse(saved);
                    Object.assign(game, data);
                    game.wheatGrowing = (game.wheatGrowing || []).map(item => ({
                        startTime: Date.now() - (item.elapsed || 0)
                    }));
                    game.applesGrowing = (game.applesGrowing || []).map(item => ({
                        startTime: Date.now() - (item.elapsed || 0)
                    }));
                    game.flourProducing = (game.flourProducing || []).map(item => ({
                        startTime: Date.now() - (item.elapsed || 0)
                    }));
                    
                    // Update device info
                    game.deviceId = DEVICE_ID;
                    game.isPWA = IS_PWA;
                }
            } catch (error) {
                console.error('Local load failed:', error);
            }
        }

        // Save to Firestore - PROFESSIONAL
        async function saveToFirestore(silent = true) {
            if (!currentUser || isSyncing || !isOnline) return;
            
            try {
                isSyncing = true;
                updateSyncStatus();
                
                game.lastUpdate = Date.now();
                game.deviceId = DEVICE_ID;
                game.isPWA = IS_PWA;
                
                const data = {
                    ...game,
                    wheatGrowing: game.wheatGrowing.map(item => ({
                        elapsed: Date.now() - item.startTime
                    })),
                    applesGrowing: game.applesGrowing.map(item => ({
                        elapsed: Date.now() - item.startTime
                    })),
                    flourProducing: game.flourProducing.map(item => ({
                        elapsed: Date.now() - item.startTime
                    })),
                    syncedAt: Date.now(),
                    version: '2.1'
                };
                
                await setDoc(doc(db, "farms", currentUser.uid), data);
                lastSync = Date.now();
                
                if (!silent) {
                    print('‚úì Cloud-Synchronisation erfolgreich', 'success');
                }
            } catch (error) {
                console.error('Cloud save failed:', error);
                if (!silent) {
                    print('‚ùå Cloud-Sync fehlgeschlagen', 'error');
                }
            } finally {
                isSyncing = false;
                updateSyncStatus();
            }
        }

        // Load from Firestore
        async function loadFromFirestore() {
            if (!currentUser) return null;
            
            try {
                const docRef = doc(db, "farms", currentUser.uid);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    return docSnap.data();
                }
                return null;
            } catch (error) {
                console.error('Cloud load failed:', error);
                return null;
            }
        }

        // INTELLIGENT SYNC CONFLICT RESOLUTION
        function compareSaves(local, cloud) {
            const localTime = local.lastUpdate || 0;
            const cloudTime = cloud.lastUpdate || 0;
            const timeDiff = Math.abs(localTime - cloudTime);
            
            // If time difference is less than 30 seconds, auto-merge (use newer)
            if (timeDiff < 30000) {
                return localTime > cloudTime ? 'local' : 'cloud';
            }
            
            // Calculate progress scores
            const localScore = (local.money || 0) + 
                              (local.wheat || 0) * 8 + 
                              (local.apples || 0) * 15 + 
                              (local.flour || 0) * 25 +
                              (local.wheatFields || 0) * 100 +
                              (local.appleTrees || 0) * 200 +
                              (local.mills || 0) * 400;
                              
            const cloudScore = (cloud.money || 0) + 
                               (cloud.wheat || 0) * 8 + 
                               (cloud.apples || 0) * 15 + 
                               (cloud.flour || 0) * 25 +
                               (cloud.wheatFields || 0) * 100 +
                               (cloud.appleTrees || 0) * 200 +
                               (cloud.mills || 0) * 400;
            
            // If scores are very similar (within 10%), use newer
            const scoreDiff = Math.abs(localScore - cloudScore);
            const avgScore = (localScore + cloudScore) / 2;
            
            if (scoreDiff / avgScore < 0.1) {
                return localTime > cloudTime ? 'local' : 'cloud';
            }
            
            // If one is significantly ahead (>20% more progress), recommend it
            if (localScore > cloudScore * 1.2) {
                return 'local-recommended';
            } else if (cloudScore > localScore * 1.2) {
                return 'cloud-recommended';
            }
            
            // Otherwise, ask user
            return 'ask';
        }

        // Show sync conflict modal
        function showSyncConflict(localData, cloudData, recommendation) {
            const modal = document.getElementById('syncConflictModal');
            const content = document.getElementById('syncConflictContent');
            
            const localDate = new Date(localData.lastUpdate || 0);
            const cloudDate = new Date(cloudData.lastUpdate || 0);
            
            const localDevice = localData.isPWA ? 'üì± App' : 'üåê Browser';
            const cloudDevice = cloudData.isPWA ? 'üì± App' : 'üåê Browser';
            
            const localRecommended = recommendation === 'local-recommended';
            const cloudRecommended = recommendation === 'cloud-recommended';
            
            content.innerHTML = `
                <p style="margin-bottom: 20px; color: #ffaa00;">
                    Du hast auf verschiedenen Ger√§ten gespielt. Welchen Spielstand m√∂chtest du behalten?
                </p>
                
                <div class="save-comparison">
                    <div class="save-card ${localRecommended ? 'recommended' : ''}">
                        <div class="save-card-title" style="color: ${localRecommended ? '#ffaa00' : '#00ff00'};">
                            üíæ LOKALER SPEICHERSTAND ${localRecommended ? '‚≠ê' : ''}
                        </div>
                        <div class="save-stat">üìÖ ${localDate.toLocaleString('de-DE')}</div>
                        <div class="save-stat">üí∞ ${localData.money} ‚Ç¨</div>
                        <div class="save-stat">üåæ ${localData.wheat} Weizen</div>
                        <div class="save-stat">üçé ${localData.apples} √Ñpfel</div>
                        <div class="save-stat">üè∫ ${localData.flour} Mehl</div>
                        <div class="save-stat">üèóÔ∏è ${localData.wheatFields || 0} Felder</div>
                        <div class="device-info">${localDevice} ‚Ä¢ Dieses Ger√§t</div>
                        ${localRecommended ? '<div style="color: #ffaa00; margin-top: 10px; font-weight: bold;">Empfohlen: Mehr Fortschritt</div>' : ''}
                    </div>
                    
                    <div class="save-card ${cloudRecommended ? 'recommended' : ''}">
                        <div class="save-card-title" style="color: ${cloudRecommended ? '#ffaa00' : '#00ff00'};">
                            ‚òÅÔ∏è CLOUD-SPEICHERSTAND ${cloudRecommended ? '‚≠ê' : ''}
                        </div>
                        <div class="save-stat">üìÖ ${cloudDate.toLocaleString('de-DE')}</div>
                        <div class="save-stat">üí∞ ${cloudData.money} ‚Ç¨</div>
                        <div class="save-stat">üåæ ${cloudData.wheat} Weizen</div>
                        <div class="save-stat">üçé ${cloudData.apples} √Ñpfel</div>
                        <div class="save-stat">üè∫ ${cloudData.flour} Mehl</div>
                        <div class="save-stat">üèóÔ∏è ${cloudData.wheatFields || 0} Felder</div>
                        <div class="device-info">${cloudDevice} ‚Ä¢ Anderes Ger√§t</div>
                        ${cloudRecommended ? '<div style="color: #ffaa00; margin-top: 10px; font-weight: bold;">Empfohlen: Mehr Fortschritt</div>' : ''}
                    </div>
                </div>
                
                <div class="choice-buttons">
                    <button class="btn ${localRecommended ? '' : 'danger'}" id="chooseLocalBtn">
                        üíæ Lokal verwenden
                    </button>
                    <button class="btn ${cloudRecommended ? '' : 'danger'}" id="chooseCloudBtn">
                        ‚òÅÔ∏è Cloud verwenden
                    </button>
                </div>
            `;
            
            document.getElementById('chooseLocalBtn').addEventListener('click', chooseLocalSave);
            document.getElementById('chooseCloudBtn').addEventListener('click', chooseCloudSave);
            
            modal.classList.add('active');
        }

        async function chooseLocalSave() {
            document.getElementById('syncConflictModal').classList.remove('active');
            await saveToFirestore(false);
            print('‚úì Lokaler Spielstand wird verwendet', 'success');
            print('‚úì Cloud aktualisiert', 'success');
        }

        function chooseCloudSave() {
            document.getElementById('syncConflictModal').classList.remove('active');
            if (pendingCloudData) {
                Object.assign(game, pendingCloudData);
                game.wheatGrowing = (game.wheatGrowing || []).map(item => ({
                    startTime: Date.now() - (item.elapsed || 0)
                }));
                game.applesGrowing = (game.applesGrowing || []).map(item => ({
                    startTime: Date.now() - (item.elapsed || 0)
                }));
                game.flourProducing = (game.flourProducing || []).map(item => ({
                    startTime: Date.now() - (item.elapsed || 0)
                }));
                game.deviceId = DEVICE_ID;
                game.isPWA = IS_PWA;
                saveLocal();
                updateDisplay();
                print('‚úì Cloud-Spielstand wird verwendet', 'success');
            }
        }

        // SYNC ON APP STATE CHANGE
        async function performSmartSync() {
            if (!currentUser || !isOnline) return;
            
            print('üîÑ Synchronisiere Spielstand...', 'info');
            
            const cloudData = await loadFromFirestore();
            
            if (!cloudData) {
                // First time - upload local data
                await saveToFirestore(false);
                print('‚úì Erstmaliger Upload abgeschlossen', 'success');
                return;
            }
            
            const localData = JSON.parse(localStorage.getItem('terminalFarmSave') || '{}');
            const decision = compareSaves(localData, cloudData);
            
            switch (decision) {
                case 'local':
                    // Auto-use local (newer and similar progress)
                    await saveToFirestore(true);
                    print('‚úì Lokaler Spielstand synchronisiert', 'success');
                    break;
                    
                case 'cloud':
                    // Auto-use cloud (newer and similar progress)
                    Object.assign(game, cloudData);
                    game.wheatGrowing = (game.wheatGrowing || []).map(item => ({
                        startTime: Date.now() - (item.elapsed || 0)
                    }));
                    game.applesGrowing = (game.applesGrowing || []).map(item => ({
                        startTime: Date.now() - (item.elapsed || 0)
                    }));
                    game.flourProducing = (game.flourProducing || []).map(item => ({
                        startTime: Date.now() - (item.elapsed || 0)
                    }));
                    game.deviceId = DEVICE_ID;
                    game.isPWA = IS_PWA;
                    saveLocal();
                    updateDisplay();
                    print('‚úì Cloud-Spielstand synchronisiert', 'success');
                    break;
                    
                case 'local-recommended':
                case 'cloud-recommended':
                case 'ask':
                    // Ask user
                    pendingCloudData = cloudData;
                    showSyncConflict(localData, cloudData, decision);
                    break;
            }
        }

        // GitHub Login
        async function githubLogin() {
            try {
                const result = await signInWithPopup(auth, provider);
                currentUser = result.user;
                print(`‚úì Eingeloggt als: ${currentUser.displayName || currentUser.reloadUserInfo?.screenName || 'GitHub User'}`, 'success');
                
                await performSmartSync();
                startCloudSync();
                updateDisplay();
            } catch (error) {
                console.error('Login failed:', error);
                print('‚ùå Login fehlgeschlagen', 'error');
            }
        }

        // Logout
        async function logout() {
            try {
                // Save before logout
                if (isOnline) {
                    await saveToFirestore(true);
                }
                
                await signOut(auth);
                currentUser = null;
                stopCloudSync();
                print('‚úì Ausgeloggt', 'success');
                updateDisplay();
            } catch (error) {
                console.error('Logout failed:', error);
                print('‚ùå Logout fehlgeschlagen', 'error');
            }
        }

        // Cloud sync management
        function startCloudSync() {
            if (syncInterval) clearInterval(syncInterval);
            
            // Sync every 60 seconds
            syncInterval = setInterval(async () => {
                if (currentUser && isOnline && Date.now() - lastSync > 60000) {
                    await saveToFirestore(true);
                }
            }, 60000);
        }

        function stopCloudSync() {
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
            }
        }

        // Login choice
        function acceptLogin() {
            document.getElementById('loginChoiceModal').classList.remove('active');
            game.loginChoiceShown = true;
            saveLocal();
            githubLogin();
        }

        function declineLogin() {
            document.getElementById('loginChoiceModal').classList.remove('active');
            game.loginChoiceShown = true;
            saveLocal();
            print('Du kannst dich jederzeit √ºber die Einstellungen anmelden!', 'info');
            print('');
        }

        // ============================================
        // MODALS
        // ============================================

        function openStatus() {
            const modal = document.getElementById('statusModal');
            const content = document.getElementById('statusContent');
            
            let html = '';
            
            if (game.wheatGrowing.length > 0) {
                html += '<div class="status-item"><div class="status-item-title">üåæ WEIZEN W√ÑCHST:</div>';
                game.wheatGrowing.forEach((item, i) => {
                    const elapsed = Date.now() - item.startTime;
                    const remaining = Math.max(0, Math.ceil((game.growthTimes.wheat - elapsed) / 1000));
                    const status = remaining > 0 ? `noch ${remaining}s` : '‚úì FERTIG!';
                    const className = remaining > 0 ? 'growing' : 'ready';
                    html += `<div class="status-item-content ${className}">[${i+1}] ${status}</div>`;
                });
                html += '</div>';
            }
            
            if (game.applesGrowing.length > 0) {
                html += '<div class="status-item"><div class="status-item-title">üçé √ÑPFEL WACHSEN:</div>';
                game.applesGrowing.forEach((item, i) => {
                    const elapsed = Date.now() - item.startTime;
                    const remaining = Math.max(0, Math.ceil((game.growthTimes.apple - elapsed) / 1000));
                    const status = remaining > 0 ? `noch ${remaining}s` : '‚úì FERTIG!';
                    const className = remaining > 0 ? 'growing' : 'ready';
                    html += `<div class="status-item-content ${className}">[${i+1}] ${status}</div>`;
                });
                html += '</div>';
            }
            
            if (game.flourProducing.length > 0) {
                html += '<div class="status-item"><div class="status-item-title">üè∫ MEHL PRODUKTION:</div>';
                game.flourProducing.forEach((item, i) => {
                    const elapsed = Date.now() - item.startTime;
                    const remaining = Math.max(0, Math.ceil((game.growthTimes.flour - elapsed) / 1000));
                    const status = remaining > 0 ? `noch ${remaining}s` : '‚úì FERTIG!';
                    const className = remaining > 0 ? 'growing' : 'ready';
                    html += `<div class="status-item-content ${className}">[${i+1}] ${status}</div>`;
                });
                html += '</div>';
            }
            
            if (game.wheatGrowing.length === 0 && game.applesGrowing.length === 0 && game.flourProducing.length === 0) {
                html += '<div class="status-item"><div class="status-item-title">üå± PRODUKTION:</div>';
                html += '<div class="status-item-content" style="color: #ffaa00;">Nichts w√§chst gerade</div></div>';
            }
            
            html += '<div class="status-item"><div class="status-item-title">üèóÔ∏è GEB√ÑUDE:</div>';
            html += `<div class="status-item-content">üåæ Weizenfelder: ${game.wheatFields}</div>`;
            html += `<div class="status-item-content">üçé Apfelb√§ume: ${game.appleTrees}</div>`;
            html += `<div class="status-item-content">‚öôÔ∏è M√ºhlen: ${game.mills}</div>`;
            html += '</div>';
            
            content.innerHTML = html;
            modal.classList.add('active');
        }

        function closeStatus() {
            document.getElementById('statusModal').classList.remove('active');
        }

        function openInventory() {
            const modal = document.getElementById('inventoryModal');
            const content = document.getElementById('inventoryContent');
            
            content.innerHTML = `
                <div class="modal-item">
                    <strong>üåæ Weizen:</strong> ${game.wheat}
                </div>
                <div class="modal-item">
                    <strong>üçé √Ñpfel:</strong> ${game.apples}
                </div>
                <div class="modal-item">
                    <strong>üè∫ Mehl:</strong> ${game.flour}
                </div>
            `;
            
            modal.classList.add('active');
        }

        function closeInventory() {
            document.getElementById('inventoryModal').classList.remove('active');
        }

        function openSettings() {
            const modal = document.getElementById('settingsModal');
            const content = document.getElementById('settingsContent');
            
            if (currentUser) {
                const lastSyncText = lastSync > 0 
                    ? new Date(lastSync).toLocaleString('de-DE')
                    : 'Noch nie';
                
                const deviceType = IS_PWA ? 'üì± Installierte App' : 'üåê Browser';
                
                content.innerHTML = `
                    <div class="modal-item">
                        <strong>üë§ Benutzer:</strong> ${currentUser.displayName || currentUser.reloadUserInfo?.screenName || 'GitHub User'}
                    </div>
                    <div class="modal-item">
                        <strong>üì± Ger√§t:</strong> ${deviceType}
                    </div>
                    <div class="modal-item">
                        <strong>üÜî Ger√§te-ID:</strong> ${DEVICE_ID.substr(0, 20)}...
                    </div>
                    <div class="modal-item">
                        <strong>üîó Status:</strong> <span style="color: #00ff00;">Mit GitHub verbunden</span>
                    </div>
                    <div class="modal-item">
                        <strong>‚òÅÔ∏è Cloud-Sync:</strong> <span style="color: #00ff00;">Aktiv (alle 60s)</span>
                    </div>
                    <div class="modal-item">
                        <strong>üïê Letzte Sync:</strong> ${lastSyncText}
                    </div>
                    <button class="btn" style="width: 100%; margin-top: 10px;" id="forceSyncBtn">üîÑ Jetzt synchronisieren</button>
                    <button class="btn danger" style="width: 100%; margin-top: 10px;" id="logoutBtn">Ausloggen</button>
                `;
                
                document.getElementById('logoutBtn').addEventListener('click', () => {
                    closeSettings();
                    logout();
                });
                
                document.getElementById('forceSyncBtn').addEventListener('click', async () => {
                    closeSettings();
                    await performSmartSync();
                });
            } else {
                const deviceType = IS_PWA ? 'üì± Installierte App' : 'üåê Browser';
                
                content.innerHTML = `
                    <div class="modal-item">
                        <strong>üì± Ger√§t:</strong> ${deviceType}
                    </div>
                    <div class="modal-item">
                        <strong>üÜî Ger√§te-ID:</strong> ${DEVICE_ID.substr(0, 20)}...
                    </div>
                    <div class="modal-item">
                        <strong>üîó Status:</strong> <span style="color: #ffaa00;">Nicht verbunden</span>
                    </div>
                    <div class="modal-item">
                        <strong>üíæ Speicherung:</strong> <span style="color: #ffaa00;">Nur lokal (alle 10s)</span>
                    </div>
                    ${!IS_PWA ? '<div class="modal-item" style="background: #221100; border-color: #ffaa00;"><strong>üí° Tipp:</strong> Installiere die App f√ºr bessere Synchronisation!</div>' : ''}
                    <div class="modal-item" style="padding: 20px; text-align: center;">
                        <p style="margin-bottom: 15px; color: #00aaff;">
                            Verbinde dich mit GitHub f√ºr Cloud-Synchronisation auf mehreren Ger√§ten!
                        </p>
                        <button class="btn" style="width: 100%;" id="loginBtn">üîó Mit GitHub verbinden</button>
                    </div>
                `;
                
                document.getElementById('loginBtn').addEventListener('click', () => {
                    closeSettings();
                    githubLogin();
                });
            }
            
            modal.classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        // Tutorial
        function startTutorial() {
            const modal = document.getElementById('tutorialModal');
            const content = document.getElementById('tutorialContent');
            
            content.innerHTML = `
                <div class="tutorial-step">
                    <h3>Schritt 1: Felder bepflanzen üåæ</h3>
                    <p>Tippe: <strong style="color: #ffaa00;">plant wheat 3</strong></p>
                    <p>Dies pflanzt Weizen auf 3 deiner Felder. Weizen w√§chst 30 Sekunden.</p>
                </div>
                
                <div class="tutorial-step">
                    <h3>Schritt 2: Ernten üì¶</h3>
                    <p>Warte 30 Sekunden und tippe: <strong style="color: #ffaa00;">harvest all</strong></p>
                    <p>Dies erntet alle fertigen Pflanzen.</p>
                </div>
                
                <div class="tutorial-step">
                    <h3>Schritt 3: Verkaufen üí∞</h3>
                    <p>Tippe: <strong style="color: #ffaa00;">sell all</strong></p>
                    <p>Dies verkauft alles in deinem Inventar und bringt dir Geld!</p>
                </div>
                
                <div class="tutorial-step">
                    <h3>Schritt 4: Erweitern üèóÔ∏è</h3>
                    <p>Tippe: <strong style="color: #ffaa00;">buy field</strong></p>
                    <p>Kaufe mehr Felder, B√§ume und M√ºhlen um zu wachsen!</p>
                </div>
                
                <div class="tutorial-step">
                    <h3>Weitere Befehle üìã</h3>
                    <p>Tippe: <strong style="color: #ffaa00;">help</strong></p>
                    <p>F√ºr eine vollst√§ndige Liste aller Befehle.</p>
                </div>
                
                <button class="btn close-modal" id="closeTutorialBtn" style="width: 100%;">
                    Los geht's! üöÄ
                </button>
            `;
            
            document.getElementById('closeTutorialBtn').addEventListener('click', closeTutorial);
            modal.classList.add('active');
        }

        function closeTutorial() {
            document.getElementById('tutorialModal').classList.remove('active');
            game.tutorialCompleted = true;
            saveLocal();
            print('‚úì Tutorial abgeschlossen! Viel Erfolg! üéâ', 'success');
            print('');
            
            if (!game.loginChoiceShown && IS_PWA) {
                setTimeout(() => {
                    document.getElementById('loginChoiceModal').classList.add('active');
                }, 500);
            }
        }

        // ============================================
        // COMMANDS
        // ============================================

        const commands = {
            help: () => {
                print('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó', 'info');
                print('‚ïë              VERF√úGBARE BEFEHLE                  ‚ïë', 'info');
                print('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù', 'info');
                print('');
                print('üå± ANBAUEN:', 'success');
                print('  plant wheat [anzahl]  - Weizen anpflanzen (30s)');
                print('  plant apple [anzahl]  - √Ñpfel anpflanzen (60s)');
                print('  produce flour [anzahl] - Mehl herstellen (120s, 2 Weizen)');
                print('');
                print('üì¶ ERNTEN:', 'success');
                print('  harvest wheat [anzahl] - Weizen ernten');
                print('  harvest apple [anzahl] - √Ñpfel ernten');
                print('  harvest flour [anzahl] - Mehl einsammeln');
                print('  harvest all           - Alles fertige ernten');
                print('');
                print('üí∞ VERKAUFEN:', 'success');
                print('  sell wheat [anzahl]   - Weizen verkaufen (8‚Ç¨)');
                print('  sell apple [anzahl]   - √Ñpfel verkaufen (15‚Ç¨)');
                print('  sell flour [anzahl]   - Mehl verkaufen (25‚Ç¨)');
                print('  sell all              - Alles verkaufen');
                print('');
                print('üèóÔ∏è KAUFEN:', 'success');
                print('  buy field [anzahl]    - Weizenfeld kaufen (100‚Ç¨)');
                print('  buy tree [anzahl]     - Apfelbaum kaufen (200‚Ç¨)');
                print('  buy mill [anzahl]     - M√ºhle kaufen (400‚Ç¨)');
                print('');
                print('üìä INFO:', 'success');
                print('  prices    - Zeige Preise');
                print('  sync      - Spielstand synchronisieren');
                print('  tutorial  - Tutorial erneut anzeigen');
                print('  clear     - Bildschirm leeren');
                print('');
            },

            sync: async () => {
                if (currentUser && isOnline) {
                    await performSmartSync();
                } else if (!currentUser) {
                    print('‚ùå Nicht eingeloggt. Nutze die Einstellungen zum Anmelden.', 'error');
                } else {
                    print('‚ùå Keine Internetverbindung', 'error');
                }
            },

            tutorial: () => {
                startTutorial();
            },

            prices: () => {
                print('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó', 'info');
                print('‚ïë              MARKTPREISE                         ‚ïë', 'info');
                print('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù', 'info');
                print('');
                print('üí∞ VERKAUFSPREISE:', 'success');
                print(`  üåæ Weizen: ${game.prices.wheat} ‚Ç¨`);
                print(`  üçé Apfel: ${game.prices.apple} ‚Ç¨`);
                print(`  üè∫ Mehl: ${game.prices.flour} ‚Ç¨`);
                print('');
                print('üèóÔ∏è KAUFPREISE:', 'warning');
                print(`  üåæ Weizenfeld: ${game.prices.wheatField} ‚Ç¨`);
                print(`  üçé Apfelbaum: ${game.prices.appleTree} ‚Ç¨`);
                print(`  ‚öôÔ∏è M√ºhle: ${game.prices.mill} ‚Ç¨`);
                print('');
            },

            plant: (args) => {
                const type = args[0];
                let amount = 1;
                if (args.length > 1) {
                    const parsed = parseInt(args[1]);
                    if (isNaN(parsed) || parsed < 1) {
                        print('‚ùå Ung√ºltige Anzahl!', 'error');
                        return;
                    }
                    amount = parsed;
                }

                if (type === 'wheat') {
                    const available = game.wheatFields - game.wheatGrowing.length;
                    if (amount > available) {
                        print(`‚ùå Nur ${available} Felder verf√ºgbar!`, 'error');
                        return;
                    }
                    for (let i = 0; i < amount; i++) {
                        game.wheatGrowing.push({ startTime: Date.now() });
                    }
                    print(`‚úì ${amount}x Weizen angepflanzt! (30s)`, 'success');
                } else if (type === 'apple') {
                    const available = game.appleTrees - game.applesGrowing.length;
                    if (amount > available) {
                        print(`‚ùå Nur ${available} B√§ume verf√ºgbar!`, 'error');
                        return;
                    }
                    for (let i = 0; i < amount; i++) {
                        game.applesGrowing.push({ startTime: Date.now() });
                    }
                    print(`‚úì ${amount}x √Ñpfel angepflanzt! (60s)`, 'success');
                } else {
                    print('‚ùå Unbekannter Typ! Nutze: wheat oder apple', 'error');
                    return;
                }
                saveLocal();
                updateDisplay();
            },

            produce: (args) => {
                const type = args[0];
                let amount = 1;
                if (args.length > 1) {
                    const parsed = parseInt(args[1]);
                    if (isNaN(parsed) || parsed < 1) {
                        print('‚ùå Ung√ºltige Anzahl!', 'error');
                        return;
                    }
                    amount = parsed;
                }

                if (type === 'flour') {
                    const available = game.mills - game.flourProducing.length;
                    if (amount > available) {
                        print(`‚ùå Nur ${available} M√ºhlen verf√ºgbar!`, 'error');
                        return;
                    }
                    const wheatNeeded = amount * 2;
                    if (game.wheat < wheatNeeded) {
                        print(`‚ùå Du brauchst ${wheatNeeded} Weizen! (Du hast ${game.wheat})`, 'error');
                        return;
                    }
                    game.wheat -= wheatNeeded;
                    for (let i = 0; i < amount; i++) {
                        game.flourProducing.push({ startTime: Date.now() });
                    }
                    print(`‚úì ${amount}x Mehl wird produziert! (120s, -${wheatNeeded} Weizen)`, 'success');
                } else {
                    print('‚ùå Unbekannter Typ! Nutze: flour', 'error');
                    return;
                }
                saveLocal();
                updateDisplay();
            },

            harvest: (args) => {
                const type = args[0];

                if (type === 'all') {
                    const readyWheat = game.wheatGrowing.filter(item => 
                        Date.now() - item.startTime >= game.growthTimes.wheat
                    );
                    game.wheat += readyWheat.length;
                    game.wheatGrowing = game.wheatGrowing.filter(item => 
                        Date.now() - item.startTime < game.growthTimes.wheat
                    );
                    if (readyWheat.length > 0) print(`‚úì ${readyWheat.length}x Weizen geerntet!`, 'success');

                    const readyApples = game.applesGrowing.filter(item => 
                        Date.now() - item.startTime >= game.growthTimes.apple
                    );
                    game.apples += readyApples.length;
                    game.applesGrowing = game.applesGrowing.filter(item => 
                        Date.now() - item.startTime < game.growthTimes.apple
                    );
                    if (readyApples.length > 0) print(`‚úì ${readyApples.length}x √Ñpfel geerntet!`, 'success');

                    const readyFlour = game.flourProducing.filter(item => 
                        Date.now() - item.startTime >= game.growthTimes.flour
                    );
                    game.flour += readyFlour.length;
                    game.flourProducing = game.flourProducing.filter(item => 
                        Date.now() - item.startTime < game.growthTimes.flour
                    );
                    if (readyFlour.length > 0) print(`‚úì ${readyFlour.length}x Mehl geerntet!`, 'success');

                    if (readyWheat.length + readyApples.length + readyFlour.length === 0) {
                        print('‚ùå Nichts bereit zum Ernten!', 'error');
                    }
                } else if (type === 'wheat') {
                    let amount = 999999;
                    if (args.length > 1) {
                        const parsed = parseInt(args[1]);
                        if (isNaN(parsed) || parsed < 1) {
                            print('‚ùå Ung√ºltige Anzahl!', 'error');
                            return;
                        }
                        amount = parsed;
                    }
                    
                    const readyWheat = game.wheatGrowing.filter(item => 
                        Date.now() - item.startTime >= game.growthTimes.wheat
                    ).slice(0, amount);
                    
                    if (readyWheat.length === 0) {
                        print('‚ùå Kein Weizen bereit zum Ernten!', 'error');
                        return;
                    }
                    
                    game.wheat += readyWheat.length;
                    game.wheatGrowing = game.wheatGrowing.filter(item => 
                        !readyWheat.includes(item)
                    );
                    print(`‚úì ${readyWheat.length}x Weizen geerntet!`, 'success');
                } else if (type === 'apple') {
                    let amount = 999999;
                    if (args.length > 1) {
                        const parsed = parseInt(args[1]);
                        if (isNaN(parsed) || parsed < 1) {
                            print('‚ùå Ung√ºltige Anzahl!', 'error');
                            return;
                        }
                        amount = parsed;
                    }
                    
                    const readyApples = game.applesGrowing.filter(item => 
                        Date.now() - item.startTime >= game.growthTimes.apple
                    ).slice(0, amount);
                    
                    if (readyApples.length === 0) {
                        print('‚ùå Keine √Ñpfel bereit zum Ernten!', 'error');
                        return;
                    }
                    
                    game.apples += readyApples.length;
                    game.applesGrowing = game.applesGrowing.filter(item => 
                        !readyApples.includes(item)
                    );
                    print(`‚úì ${readyApples.length}x √Ñpfel geerntet!`, 'success');
                } else if (type === 'flour') {
                    let amount = 999999;
                    if (args.length > 1) {
                        const parsed = parseInt(args[1]);
                        if (isNaN(parsed) || parsed < 1) {
                            print('‚ùå Ung√ºltige Anzahl!', 'error');
                            return;
                        }
                        amount = parsed;
                    }
                    
                    const readyFlour = game.flourProducing.filter(item => 
                        Date.now() - item.startTime >= game.growthTimes.flour
                    ).slice(0, amount);
                    
                    if (readyFlour.length === 0) {
                        print('‚ùå Kein Mehl bereit zum Ernten!', 'error');
                        return;
                    }
                    
                    game.flour += readyFlour.length;
                    game.flourProducing = game.flourProducing.filter(item => 
                        !readyFlour.includes(item)
                    );
                    print(`‚úì ${readyFlour.length}x Mehl geerntet!`, 'success');
                } else {
                    print('‚ùå Unbekannter Typ! Nutze: wheat, apple, flour oder all', 'error');
                    return;
                }
                saveLocal();
                updateDisplay();
            },

            sell: (args) => {
                const type = args[0];

                if (type === 'all') {
                    const total = (game.wheat * game.prices.wheat) + 
                                (game.apples * game.prices.apple) + 
                                (game.flour * game.prices.flour);
                    if (total === 0) {
                        print('‚ùå Nichts zum Verkaufen!', 'error');
                        return;
                    }
                    print(`‚úì Verkauft: ${game.wheat} Weizen, ${game.apples} √Ñpfel, ${game.flour} Mehl`, 'success');
                    print(`üí∞ +${total} ‚Ç¨ erhalten!`, 'success');
                    game.money += total;
                    game.wheat = 0;
                    game.apples = 0;
                    game.flour = 0;
                } else if (type === 'wheat') {
                    let amount = game.wheat;
                    if (args.length > 1) {
                        const parsed = parseInt(args[1]);
                        if (isNaN(parsed) || parsed < 1) {
                            print('‚ùå Ung√ºltige Anzahl!', 'error');
                            return;
                        }
                        amount = parsed;
                    }
                    
                    if (amount > game.wheat) {
                        print(`‚ùå Du hast nur ${game.wheat} Weizen!`, 'error');
                        return;
                    }
                    const earned = amount * game.prices.wheat;
                    game.wheat -= amount;
                    game.money += earned;
                    print(`‚úì ${amount}x Weizen verkauft! (+${earned} ‚Ç¨)`, 'success');
                } else if (type === 'apple') {
                    let amount = game.apples;
                    if (args.length > 1) {
                        const parsed = parseInt(args[1]);
                        if (isNaN(parsed) || parsed < 1) {
                            print('‚ùå Ung√ºltige Anzahl!', 'error');
                            return;
                        }
                        amount = parsed;
                    }
                    
                    if (amount > game.apples) {
                        print(`‚ùå Du hast nur ${game.apples} √Ñpfel!`, 'error');
                        return;
                    }
                    const earned = amount * game.prices.apple;
                    game.apples -= amount;
                    game.money += earned;
                    print(`‚úì ${amount}x √Ñpfel verkauft! (+${earned} ‚Ç¨)`, 'success');
                } else if (type === 'flour') {
                    let amount = game.flour;
                    if (args.length > 1) {
                        const parsed = parseInt(args[1]);
                        if (isNaN(parsed) || parsed < 1) {
                            print('‚ùå Ung√ºltige Anzahl!', 'error');
                            return;
                        }
                        amount = parsed;
                    }
                    
                    if (amount > game.flour) {
                        print(`‚ùå Du hast nur ${game.flour} Mehl!`, 'error');
                        return;
                    }
                    const earned = amount * game.prices.flour;
                    game.flour -= amount;
                    game.money += earned;
                    print(`‚úì ${amount}x Mehl verkauft! (+${earned} ‚Ç¨)`, 'success');
                } else {
                    print('‚ùå Unbekannter Typ! Nutze: wheat, apple, flour oder all', 'error');
                    return;
                }
                saveLocal();
                updateDisplay();
            },

            buy: (args) => {
                const type = args[0];
                let amount = 1;
                if (args.length > 1) {
                    const parsed = parseInt(args[1]);
                    if (isNaN(parsed) || parsed < 1) {
                        print('‚ùå Ung√ºltige Anzahl!', 'error');
                        return;
                    }
                    amount = parsed;
                }

                if (type === 'field') {
                    const totalCost = game.prices.wheatField * amount;
                    if (game.money < totalCost) {
                        print(`‚ùå Nicht genug Geld! Ben√∂tigt: ${totalCost} ‚Ç¨ (hast ${game.money} ‚Ç¨)`, 'error');
                        return;
                    }
                    game.money -= totalCost;
                    game.wheatFields += amount;
                    print(`‚úì ${amount}x Weizenfeld gekauft! (-${totalCost} ‚Ç¨)`, 'success');
                } else if (type === 'tree') {
                    const totalCost = game.prices.appleTree * amount;
                    if (game.money < totalCost) {
                        print(`‚ùå Nicht genug Geld! Ben√∂tigt: ${totalCost} ‚Ç¨ (hast ${game.money} ‚Ç¨)`, 'error');
                        return;
                    }
                    game.money -= totalCost;
                    game.appleTrees += amount;
                    print(`‚úì ${amount}x Apfelbaum gekauft! (-${totalCost} ‚Ç¨)`, 'success');
                } else if (type === 'mill') {
                    const totalCost = game.prices.mill * amount;
                    if (game.money < totalCost) {
                        print(`‚ùå Nicht genug Geld! Ben√∂tigt: ${totalCost} ‚Ç¨ (hast ${game.money} ‚Ç¨)`, 'error');
                        return;
                    }
                    game.money -= totalCost;
                    game.mills += amount;
                    print(`‚úì ${amount}x M√ºhle gekauft! (-${totalCost} ‚Ç¨)`, 'success');
                } else {
                    print('‚ùå Unbekannter Typ! Nutze: field, tree oder mill', 'error');
                    return;
                }
                saveLocal();
                updateDisplay();
            },

            clear: () => {
                terminal.innerHTML = '';
            }
        };

        // Process command
        function processCommand(cmd) {
            print(`farm@terminal:~$ ${cmd}`, 'info');
            
            const parts = cmd.trim().toLowerCase().split(/\s+/);
            const command = parts[0];
            const args = parts.slice(1);

            if (commands[command]) {
                commands[command](args);
            } else if (cmd.trim() === '') {
                // Do nothing
            } else {
                print(`‚ùå Befehl nicht gefunden: ${command}`, 'error');
                print('Tippe "help" f√ºr alle Befehle.', 'warning');
            }
            print('');
        }

        // Input handling
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const cmd = input.value;
                input.value = '';
                processCommand(cmd);
            }
        });

        // Keep input focused
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.modal-content') && !e.target.closest('#pwaInstallBanner')) {
                input.focus();
            }
        });

        // ============================================
        // CONNECTION STATE MANAGEMENT
        // ============================================

        window.addEventListener('online', async () => {
            const wasOffline = !isOnline;
            isOnline = true;
            updateSyncStatus();
            
            if (wasOffline) {
                print('‚úì Verbindung wiederhergestellt', 'success');
                
                if (currentUser) {
                    await performSmartSync();
                    startCloudSync();
                }
            }
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            updateSyncStatus();
            print('‚ö†Ô∏è Offline-Modus - Daten werden lokal gespeichert', 'warning');
            stopCloudSync();
        });

        // APP LIFECYCLE EVENTS
        document.addEventListener('visibilitychange', async () => {
            if (document.visibilityState === 'visible') {
                // App wurde wieder ge√∂ffnet - Smart Sync
                if (currentUser && isOnline && Date.now() - lastSync > 60000) {
                    await performSmartSync();
                }
            } else {
                // App wird minimiert - Speichern
                saveLocal();
                if (currentUser && isOnline) {
                    await saveToFirestore(true);
                }
            }
        });

        // Before unload - Save
        window.addEventListener('beforeunload', () => {
            saveLocal();
        });

        // Auth state observer
        onAuthStateChanged(auth, (user) => {
            if (user && !currentUser) {
                currentUser = user;
                startCloudSync();
            } else if (!user && currentUser) {
                currentUser = null;
                stopCloudSync();
            }
            updateSyncStatus();
        });

        // Auto-save local every 10 seconds - ALWAYS
        setInterval(() => {
            saveLocal();
        }, 10000);

        // Update display every second
        setInterval(updateDisplay, 1000);

        // Welcome message
        function printWelcome() {
            print('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
            print('   üåæ Willkommen bei TERMINAL FARM! üåæ', 'info');
            print('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
            print('');
            
            if (IS_PWA) {
                print('‚úì App-Modus aktiv', 'success');
            } else {
                print('üí° Tipp: Installiere die App f√ºr bessere Performance!', 'warning');
            }
            
            print('');
            print('Baue Pflanzen an, produziere Waren und verkaufe sie!', 'info');
            print('');
            print('Tippe "help" f√ºr alle Befehle!', 'warning');
            print('');
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        
        loadLocal();
        updateDisplay();
        printWelcome();

        // Show tutorial for new players
        if (!game.tutorialCompleted) {
            setTimeout(startTutorial, 1000);
        } else if (!game.loginChoiceShown && IS_PWA) {
            // Show login choice if PWA and not shown yet
            setTimeout(() => {
                document.getElementById('loginChoiceModal').classList.add('active');
            }, 2000);
        }
    </script>
</body>
</html>
